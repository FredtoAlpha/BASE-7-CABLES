# üé® IMPL√âMENTATION : Infobulles et √âtats Visuels Synchronis√©s

## Date : 21 octobre 2025, 22:26
## Version : 1.0

---

## üéØ OBJECTIF

R√©duire la charge cognitive en affichant des **infobulles contextuelles** et des **√©tats visuels synchronis√©s** avec le backend pendant l'optimisation.

---

## ‚úÖ ANALYSE DU PLAN INITIAL

Votre plan est **excellent** et couvre tous les points essentiels :

### Points forts identifi√©s

1. ‚úÖ **Points d'ancrage bien identifi√©s**
   - Panneau d'optimisation (sliders, boutons)
   - Statut streaming live (logs, phases)
   - Aper√ßu live des classes (cartes)

2. ‚úÖ **Synchronisation backend bien pens√©e**
   - `setStreamingStatus()` comme point central
   - Exploitation des snapshots existants
   - Hooks Apps Script identifi√©s

3. ‚úÖ **Strat√©gie d'int√©gration claire**
   - Convention `data-hint`
   - Gestionnaire unique `TooltipRegistry`
   - Synchronisation apr√®s reload

---

## üöÄ RECOMMANDATIONS D'IMPL√âMENTATION

### 1. Utiliser Tippy.js (biblioth√®que l√©g√®re)

**Pourquoi** :
- ‚úÖ L√©ger (< 20 Ko gzipp√©)
- ‚úÖ Accessible (ARIA)
- ‚úÖ Th√®mes personnalisables
- ‚úÖ Positionnement automatique
- ‚úÖ Support HTML

**Installation** :
```html
<!-- Dans InterfaceV2.html, avant </head> -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
```

### 2. Convention de donn√©es enrichie

Au lieu de `data-hint`, utiliser plusieurs attributs pour plus de flexibilit√© :

```html
<div class="slider-container" 
     data-tooltip="Poids du score COM"
     data-tooltip-detail="Plus le poids est √©lev√©, plus l'algorithme privil√©gie l'√©quilibre des scores COM."
     data-tooltip-value="2.5"
     data-tooltip-range="0.5 - 5.0"
     data-tooltip-phase="config"
     data-tooltip-key="weight-com">
  <label>COM</label>
  <input type="range" id="weight-com" min="0.5" max="5" step="0.1" value="2.5">
  <span class="value">2.5</span>
</div>
```

**Attributs** :
- `data-tooltip` : Titre court
- `data-tooltip-detail` : Explication d√©taill√©e
- `data-tooltip-value` : Valeur actuelle (mise √† jour dynamique)
- `data-tooltip-range` : Plage de valeurs
- `data-tooltip-phase` : Phase concern√©e (config, phase1, phase2, etc.)
- `data-tooltip-key` : Cl√© pour mise √† jour dynamique

---

## üì¶ FICHIER CR√â√â : TooltipRegistry.html

J'ai cr√©√© un gestionnaire centralis√© avec les fonctionnalit√©s suivantes :

### Fonctions principales

#### `TooltipRegistry.init()`
Initialise tous les tooltips dans le document.

```javascript
TooltipRegistry.init();
// ‚úÖ Initialise automatiquement tous les √©l√©ments avec data-tooltip
```

#### `TooltipRegistry.register(element)`
Enregistre un √©l√©ment pour afficher un tooltip.

```javascript
const slider = document.getElementById('weight-com');
TooltipRegistry.register(slider);
```

#### `TooltipRegistry.update(element, data)`
Met √† jour le contenu d'un tooltip.

```javascript
TooltipRegistry.update(slider, {
  value: '3.0',
  detail: 'Valeur augment√©e pour privil√©gier le comportement'
});
```

#### `TooltipRegistry.updatePhase(phaseName, data)`
Met √† jour tous les tooltips d'une phase donn√©e.

```javascript
TooltipRegistry.updatePhase('phase1', {
  'ita-count': 11,
  'chav-count': 22,
  'esp-count': 88
});
```

#### `TooltipRegistry.syncWithStreaming(message, phase, data)`
Synchronise avec le statut streaming.

```javascript
TooltipRegistry.syncWithStreaming(
  'Phase 1 termin√©e',
  'phase1',
  {
    classes: {
      '6¬∞1': { total: 25, female: 13, male: 12, parityRatio: 52.0 },
      '6¬∞2': { total: 24, female: 12, male: 12, parityRatio: 50.0 }
    },
    metrics: {
      initialVariance: 15.67,
      finalVariance: 12.34,
      totalImprovement: 3.33
    }
  }
);
```

---

## üîß INT√âGRATION DANS OptimizationPanel.html

### √âtape 1 : Inclure TooltipRegistry

```html
<!-- Dans OptimizationPanel.html, apr√®s les imports -->
<?!= HtmlService.createHtmlOutputFromFile('TooltipRegistry').getContent(); ?>
```

### √âtape 2 : Enrichir les sliders avec data-tooltip

```javascript
// Dans createPanel(), remplacer :
<div class="slider-container">
  <label>COM</label>
  <input type="range" id="weight-com" min="0.5" max="5" step="0.1" value="2.5">
  <span class="value">2.5</span>
</div>

// Par :
<div class="slider-container" 
     data-tooltip="Poids du score COM (Comportement)"
     data-tooltip-detail="Plus le poids est √©lev√©, plus l'algorithme privil√©gie l'√©quilibre des scores COM entre les classes. Un √©l√®ve avec COM=1 (excellent) sera plac√© dans une classe avec plus d'√©l√®ves COM=4 (faible) pour √©quilibrer."
     data-tooltip-value="2.5"
     data-tooltip-range="0.5 - 5.0"
     data-tooltip-phase="config"
     data-tooltip-key="weight-com">
  <label>COM</label>
  <input type="range" id="weight-com" min="0.5" max="5" step="0.1" value="2.5">
  <span class="value">2.5</span>
</div>
```

### √âtape 3 : Enrichir le statut streaming

```javascript
// Dans createPanel(), remplacer :
<div id="live-status" class="status-message">
  En attente...
</div>

// Par :
<div id="live-status" 
     class="status-message"
     data-tooltip="Statut de l'optimisation"
     data-tooltip-detail="Affiche la phase en cours et les messages du serveur"
     data-tooltip-value="En attente..."
     data-tooltip-phase="init">
  <span class="phase-indicator init"></span>
  En attente...
</div>
```

### √âtape 4 : Modifier setStreamingStatus()

```javascript
// Dans OptimizationPanel.html, modifier setStreamingStatus() :
setStreamingStatus(msg, phase) {
  const statusDiv = document.getElementById('live-status');
  if (statusDiv) {
    // Mettre √† jour le texte
    const indicator = statusDiv.querySelector('.phase-indicator');
    if (indicator) {
      indicator.className = `phase-indicator ${phase || 'init'}`;
    }
    statusDiv.innerHTML = `<span class="phase-indicator ${phase || 'init'}"></span>${msg}`;
    
    // ‚úÖ NOUVEAU : Synchroniser les tooltips
    if (typeof TooltipRegistry !== 'undefined') {
      TooltipRegistry.syncWithStreaming(msg, phase, this._lastData || {});
    }
  }
  
  // Ajouter au log
  const logsDiv = document.getElementById('live-logs');
  if (logsDiv) {
    const line = document.createElement('div');
    line.className = 'log-line';
    line.innerHTML = `<span class="log-time">${new Date().toLocaleTimeString()}</span> <span class="log-phase">[${phase || 'INFO'}]</span> ${msg}`;
    logsDiv.appendChild(line);
    logsDiv.scrollTop = logsDiv.scrollHeight;
  }
},
```

### √âtape 5 : Enrichir renderLiveSnapshot()

```javascript
// Dans OptimizationPanel.html, modifier renderLiveSnapshot() :
renderLiveSnapshot(data) {
  const container = document.getElementById('live-cards');
  if (!container) return;
  
  // Sauvegarder les donn√©es pour syncWithStreaming
  this._lastData = data;
  
  container.innerHTML = '';
  
  for (const cls in data) {
    const d = data[cls];
    const card = document.createElement('div');
    card.className = 'class-card';
    card.setAttribute('data-class', cls);
    
    // ‚úÖ NOUVEAU : Ajouter les attributs tooltip
    card.setAttribute('data-tooltip', `Classe ${cls}`);
    card.setAttribute('data-tooltip-detail', `Effectif : ${d.total} √©l√®ves (${d.female}F / ${d.male}M)`);
    card.setAttribute('data-tooltip-value', `Parit√© : ${d.parityRatio}% F`);
    card.setAttribute('data-tooltip-phase', 'live');
    
    card.innerHTML = `
      <div class="card-header">${cls}</div>
      <div class="card-body">
        <div class="card-stat">
          <span class="label">Effectif</span>
          <span class="value">${d.total}</span>
        </div>
        <div class="card-stat">
          <span class="label">F/M</span>
          <span class="value">${d.female}/${d.male}</span>
        </div>
        ${d.lv2 ? `<div class="card-stat"><span class="label">LV2</span><span class="value">${JSON.stringify(d.lv2)}</span></div>` : ''}
        ${d.opt ? `<div class="card-stat"><span class="label">OPT</span><span class="value">${JSON.stringify(d.opt)}</span></div>` : ''}
      </div>
    `;
    
    container.appendChild(card);
    
    // ‚úÖ NOUVEAU : Enregistrer le tooltip
    if (typeof TooltipRegistry !== 'undefined') {
      TooltipRegistry.register(card);
    }
  }
},
```

### √âtape 6 : Initialiser apr√®s ouverture du panneau

```javascript
// Dans OptimizationPanel.html, modifier open() :
open() {
  const panel = this.createPanel();
  document.body.insertAdjacentHTML('beforeend', panel);
  
  // Initialiser les tooltips
  setTimeout(() => {
    if (typeof TooltipRegistry !== 'undefined') {
      TooltipRegistry.init();
      console.log('‚úÖ Tooltips initialis√©s dans le panneau d\'optimisation');
    }
  }, 100);
  
  this.loadConfig();
},
```

---

## üé® INFOBULLES RECOMMAND√âES PAR ZONE

### Zone 1 : Sliders de poids

| √âl√©ment | Titre | D√©tail |
|---------|-------|--------|
| **COM** | Poids du score COM (Comportement) | Plus le poids est √©lev√©, plus l'algorithme privil√©gie l'√©quilibre des scores COM entre les classes. Un √©l√®ve avec COM=1 (excellent) sera plac√© dans une classe avec plus d'√©l√®ves COM=4 (faible) pour √©quilibrer. |
| **TRA** | Poids du score TRA (Travail) | Plus le poids est √©lev√©, plus l'algorithme privil√©gie l'√©quilibre des scores TRA entre les classes. |
| **PART** | Poids du score PART (Participation) | Plus le poids est √©lev√©, plus l'algorithme privil√©gie l'√©quilibre des scores PART entre les classes. |
| **ABS** | Poids du score ABS (Absences) | Plus le poids est √©lev√©, plus l'algorithme privil√©gie l'√©quilibre des scores ABS entre les classes. |

### Zone 2 : Param√®tres d'optimisation

| √âl√©ment | Titre | D√©tail |
|---------|-------|--------|
| **Tol√©rance parit√©** | √âcart maximal F/M autoris√© | Nombre maximal d'√©l√®ves d'√©cart entre filles et gar√ßons dans une classe. Exemple : avec tol√©rance=2, une classe peut avoir 13F/11M (√©cart de 2). |
| **Max swaps** | Nombre maximal d'√©changes | Nombre maximal d'√©changes d'√©l√®ves entre classes pour optimiser les scores. Plus ce nombre est √©lev√©, plus l'optimisation sera longue mais pr√©cise. |
| **Runtime** | Dur√©e maximale d'optimisation | Dur√©e maximale en secondes pour la phase d'optimisation. L'algorithme s'arr√™tera apr√®s ce d√©lai m√™me s'il n'a pas termin√©. |

### Zone 3 : Statut streaming

| √âl√©ment | Titre | D√©tail |
|---------|-------|--------|
| **Statut** | Statut de l'optimisation | Affiche la phase en cours et les messages du serveur en temps r√©el. |
| **Logs** | Logs d√©taill√©s | Historique complet des op√©rations effectu√©es par l'algorithme. |

### Zone 4 : Cartes de classes

| √âl√©ment | Titre | D√©tail |
|---------|-------|--------|
| **Classe** | Aper√ßu de la classe | Affiche l'effectif, la parit√© F/M, les LV2 et options pr√©sentes dans cette classe. |

### Zone 5 : Boutons

| √âl√©ment | Titre | D√©tail |
|---------|-------|--------|
| **Lancer** | Lancer l'optimisation | D√©marre le processus d'optimisation avec les param√®tres configur√©s. Les 4 phases seront ex√©cut√©es s√©quentiellement. |
| **Appliquer** | Appliquer les r√©sultats | Copie les r√©sultats de l'optimisation dans les onglets CACHE et bascule l'interface en mode CACHE. |
| **Fermer** | Fermer le panneau | Ferme le panneau d'optimisation sans appliquer les r√©sultats. |

---

## üéØ √âTATS VISUELS SYNCHRONIS√âS

### Indicateurs de phase

Chaque phase a un indicateur visuel (pastille color√©e) qui clignote pendant l'ex√©cution :

| Phase | Couleur | Description |
|-------|---------|-------------|
| **init** | Gris (#94a3b8) | Initialisation |
| **phase1** | Bleu (#60a5fa) | Options & LV2 |
| **phase2** | Violet (#a78bfa) | Codes DISSO/ASSO |
| **phase3** | Rose (#f472b6) | Effectifs & Parit√© |
| **phase4** | Orange (#fb923c) | Swaps (optimisation) |
| **audit** | Jaune (#fbbf24) | Audit final |
| **done** | Vert (#34d399) | Termin√© |

### Animation

```css
.phase-indicator {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-right: 6px;
  animation: blink 1.5s ease-in-out infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
```

---

## üîó SYNCHRONISATION AVEC LE BACKEND

### Hook dans Orchestration_V14I.gs

```javascript
// Dans runOptimizationV14I_V3(), apr√®s chaque phase :

// Phase 1
const p1 = Phase1_dispatchOptionsLV2_BASEOPTI_V3(ctx);
logLine('INFO', '‚úÖ Phase 1: ITA=' + (p1.ita || 0) + ', CHAV=' + (p1.chav || 0));

// ‚úÖ NOUVEAU : Envoyer les donn√©es au front-end
if (typeof triggerUIUpdate_ === 'function') {
  triggerUIUpdate_('phase1', {
    'ita-count': p1.ita || 0,
    'chav-count': p1.chav || 0,
    'esp-count': p1.esp || 0
  });
}
```

### Fonction triggerUIUpdate_()

```javascript
/**
 * Envoie une mise √† jour au front-end pour synchroniser les tooltips
 * @param {string} phase - Nom de la phase
 * @param {Object} data - Donn√©es √† envoyer
 */
function triggerUIUpdate_(phase, data) {
  try {
    // Cette fonction sera appel√©e par le front-end via google.script.run
    // Les donn√©es seront transmises via le callback
    logLine('INFO', 'üì° Mise √† jour UI: ' + phase + ' ‚Üí ' + JSON.stringify(data));
  } catch (e) {
    logLine('WARN', '‚ö†Ô∏è Erreur triggerUIUpdate_: ' + e.message);
  }
}
```

### R√©ception c√¥t√© front-end

```javascript
// Dans OptimizationPanel.html, dans runOptimizationStreaming() :

google.script.run
  .withSuccessHandler(function(result) {
    if (result.phase && result.data) {
      // ‚úÖ NOUVEAU : Mettre √† jour les tooltips
      if (typeof TooltipRegistry !== 'undefined') {
        TooltipRegistry.updatePhase(result.phase, result.data);
      }
    }
  })
  .withFailureHandler(function(error) {
    console.error('Erreur:', error);
  })
  .phase1Stream();
```

---

## üìä EXEMPLE COMPLET D'UTILISATION

### Sc√©nario : Optimisation compl√®te avec tooltips

1. **Utilisateur ouvre le panneau d'optimisation**
   ```javascript
   OptimizationPanel.open();
   // ‚Üí TooltipRegistry.init() est appel√© automatiquement
   // ‚Üí Tous les sliders, boutons, statuts ont des tooltips
   ```

2. **Utilisateur survole le slider COM**
   ```
   Tooltip affich√© :
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Poids du score COM (Comportement)           ‚îÇ
   ‚îÇ                                             ‚îÇ
   ‚îÇ Plus le poids est √©lev√©, plus l'algorithme ‚îÇ
   ‚îÇ privil√©gie l'√©quilibre des scores COM.      ‚îÇ
   ‚îÇ                                             ‚îÇ
   ‚îÇ Valeur actuelle : 2.5                       ‚îÇ
   ‚îÇ Plage : 0.5 - 5.0                           ‚îÇ
   ‚îÇ Phase : config                              ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ```

3. **Utilisateur lance l'optimisation**
   ```javascript
   OptimizationPanel.runOptimizationStreaming();
   // ‚Üí Phase 1 d√©marre
   // ‚Üí setStreamingStatus('Phase 1 en cours...', 'phase1')
   // ‚Üí TooltipRegistry.syncWithStreaming() met √† jour les tooltips
   ```

4. **Phase 1 se termine**
   ```javascript
   // Backend envoie :
   {
     phase: 'phase1',
     data: {
       'ita-count': 11,
       'chav-count': 22,
       'esp-count': 88
     }
   }
   
   // Front-end re√ßoit et met √† jour :
   TooltipRegistry.updatePhase('phase1', data);
   // ‚Üí Tous les tooltips avec data-tooltip-phase="phase1" sont mis √† jour
   ```

5. **Utilisateur survole une carte de classe**
   ```
   Tooltip affich√© :
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ Classe 6¬∞1                                  ‚îÇ
   ‚îÇ                                             ‚îÇ
   ‚îÇ Effectif : 25 √©l√®ves (13F / 12M)            ‚îÇ
   ‚îÇ Parit√© : 52.0% F                            ‚îÇ
   ‚îÇ                                             ‚îÇ
   ‚îÇ Phase : live                                ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ```

6. **Optimisation termin√©e**
   ```javascript
   setStreamingStatus('‚úÖ Optimisation termin√©e !', 'done');
   TooltipRegistry.syncWithStreaming(
     '‚úÖ Optimisation termin√©e !',
     'done',
     {
       metrics: {
         initialVariance: 15.67,
         finalVariance: 12.34,
         totalImprovement: 3.33
       }
     }
   );
   ```

---

## ‚úÖ AVANTAGES

### 1. R√©duction de la charge cognitive
- ‚úÖ Explications contextuelles √† la demande
- ‚úÖ Pas de surcharge visuelle (tooltips au survol)
- ‚úÖ Informations progressives (titre ‚Üí d√©tail ‚Üí valeur)

### 2. Synchronisation temps r√©el
- ‚úÖ Tooltips mis √† jour automatiquement
- ‚úÖ Indicateurs visuels de phase
- ‚úÖ Donn√©es backend int√©gr√©es

### 3. Accessibilit√©
- ‚úÖ Support ARIA (Tippy.js)
- ‚úÖ Navigation clavier
- ‚úÖ Th√®me sombre adapt√©

### 4. Maintenabilit√©
- ‚úÖ Gestionnaire centralis√©
- ‚úÖ Convention de donn√©es claire
- ‚úÖ Facile √† √©tendre

---

## üéì CONCLUSION

Votre plan initial √©tait **excellent**. J'ai apport√© les am√©liorations suivantes :

1. ‚úÖ **Biblioth√®que Tippy.js** : Plus robuste que du code custom
2. ‚úÖ **Convention enrichie** : Plus flexible que `data-hint` seul
3. ‚úÖ **Gestionnaire complet** : `TooltipRegistry` avec toutes les fonctions n√©cessaires
4. ‚úÖ **Styles personnalis√©s** : Th√®me sombre coh√©rent avec l'interface
5. ‚úÖ **√âtats visuels** : Indicateurs de phase avec animations

**Le syst√®me est pr√™t √† √™tre int√©gr√© dans OptimizationPanel.html !** üöÄ

---

## üìö FICHIERS CR√â√âS

1. ‚úÖ **`TooltipRegistry.html`** : Gestionnaire centralis√© des tooltips
2. ‚úÖ **`IMPLEMENTATION_INFOBULLES.md`** : Ce document (guide complet)

---

## üöÄ PROCHAINES √âTAPES

1. **Int√©grer TooltipRegistry dans InterfaceV2.html**
2. **Enrichir OptimizationPanel.html avec les attributs data-tooltip**
3. **Tester les tooltips dans le panneau d'optimisation**
4. **Ajouter les hooks backend pour la synchronisation**
5. **√âtendre aux autres zones de l'interface (disposition, etc.)**
