<!DOCTYPE html>
<html lang="fr">
<head>
  <script>console.log("GEMINI_DEBUG: Running latest version of InterfaceV2.html");</script>
  
  <!-- Bloquer document.write pour éviter injection HTML dans JS lors de OAuth -->
  <script>
  (function(){
    try {
      var p = new URLSearchParams(location.search);
      if (p.get('createOAuthDialog') === 'true') {
        var orig = document.write.bind(document);
        document.write = function(s){
          console.warn('Blocked document.write from external script:', String(s).slice(0,60));
          // ne rien écrire pour éviter le HTML dans le flux JS
        };
      }
    } catch(e){}
  })();
  </script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Répartition Classes - Version Universelle</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SortableJS pour drag & drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Font Awesome pour les icônes -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js pour les graphiques -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS pour export Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- jsPDF pour export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- html2canvas pour screenshots PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Shepherd.js pour tour guidé -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/css/shepherd.css">
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/js/shepherd.min.js"></script>
  
  <!-- Style pour forcer le centrage du tutoriel Shepherd -->
  <style>
    /* Forcer le centrage et limiter la hauteur des modals Shepherd */
    .shepherd-element {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      max-height: 85vh !important;
      overflow-y: auto !important;
      z-index: 9999 !important;
    }
    
    .shepherd-content {
      max-height: 75vh !important;
      overflow-y: auto !important;
    }
    
    .shepherd-text {
      max-height: 60vh !important;
      overflow-y: auto !important;
    }
    
    /* S'assurer que les boutons sont toujours visibles */
    .shepherd-footer {
      position: sticky !important;
      bottom: 0 !important;
      background: white !important;
      padding: 1rem !important;
      border-top: 1px solid #e5e7eb !important;
      margin-top: 1rem !important;
    }
  </style>
  
  <style id="interfaceV2-styles">
    <?!= include('InterfaceV2_Styles'); ?>
  </style>
  
  <!-- CSS des optimisations V3 -->
  <style id="v3-optimizations">
    <?!= include('styles-animations'); ?>
    <?!= include('styles-progress-bars'); ?>
    <?!= include('styles-dark-mode'); ?>
  </style>
</head>
<body class="min-h-screen bg-gray-50 font-sans text-slate-800">

<!-- SPINNER DE CHARGEMENT GLOBAL -->
<div id="loadingSpinner" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
  <div class="spinner"></div>
</div>

<!-- 1. MODAL DE DÉMARRAGE (indépendant) - DESIGN MODERNE -->
<div id="startupModal" class="fixed inset-0 z-[200000] flex items-center justify-center bg-gradient-to-br from-purple-900/95 to-indigo-900/95 backdrop-blur-sm hidden transition-opacity duration-300" role="dialog" aria-modal="true" aria-labelledby="modal-title">
  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full relative transform transition-all duration-300 scale-95 opacity-0" id="startupModalContent">
    <!-- Bouton de fermeture -->
    <button id="closeStartupModal" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 transition-all duration-200 hover:rotate-90" title="Fermer" aria-label="Fermer">
      <i class="fa fa-times text-lg"></i>
    </button>
    
    <!-- Header avec icône et titre -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-purple-500 to-indigo-600 mb-4 shadow-lg">
        <i class="fas fa-layer-group text-2xl text-white"></i>
      </div>
      <h2 id="modal-title" class="text-3xl font-bold text-gray-800 mb-2">Choisissez votre espace de travail</h2>
      <p class="text-gray-500 text-sm">Sélectionnez le mode adapté à votre rôle et à vos besoins</p>
    </div>
    
    <!-- Section PROFESSEURS -->
    <div class="mb-8">
      <div class="flex items-center gap-2 mb-4">
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
        <div class="flex items-center gap-2 px-4 py-2 bg-emerald-50 rounded-full">
          <i class="fas fa-chalkboard-teacher text-emerald-600"></i>
          <span class="text-sm font-bold text-emerald-700">PROFESSEURS</span>
        </div>
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
      </div>
      
      <div class="grid grid-cols-2 gap-4">
        <!-- Card TEST -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-emerald-200 bg-gradient-to-br from-emerald-50 to-emerald-100 p-6 text-left transition-all duration-300 hover:border-emerald-400 hover:shadow-xl hover:-translate-y-1" data-mode="TEST">
          <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="flex items-center justify-between mb-3">
              <div class="w-12 h-12 rounded-lg bg-emerald-500 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-flask text-xl text-white"></i>
              </div>
              <span class="px-3 py-1 bg-emerald-500 text-white text-xs font-bold rounded-full">TEST</span>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Base préparée</h3>
            <p class="text-sm text-gray-600 mb-3">Modifications manuelles</p>
          </div>
        </button>
        
        <!-- Card CACHE -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-amber-200 bg-gradient-to-br from-amber-50 to-amber-100 p-6 text-left transition-all duration-300 hover:border-amber-400 hover:shadow-xl hover:-translate-y-1" data-mode="CACHE">
          <div class="absolute top-0 right-0 w-32 h-32 bg-amber-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="flex items-center justify-between mb-3">
              <div class="w-12 h-12 rounded-lg bg-amber-500 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300">
                <i class="fas fa-save text-xl text-white"></i>
              </div>
              <span class="px-3 py-1 bg-amber-500 text-white text-xs font-bold rounded-full">CACHE</span>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Brouillon sauvegardé</h3>
            <p class="text-sm text-gray-600 mb-3">Reprendre où vous en étiez</p>
          </div>
        </button>
      </div>
      
      
      <!-- Restauration auto-sauvegarde (sécurité discrète) -->
      <div id="restoreCacheBlock" class="mt-4 hidden">
        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 flex items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 rounded-full bg-amber-100 flex items-center justify-center">
            <i class="fas fa-history text-amber-600"></i>
          </div>
          <div class="flex-1">
            <p class="text-sm font-medium text-amber-900 mb-1">Brouillon non sauvegardé détecté</p>
            <p class="text-xs text-amber-700 mb-2">Dernière auto-sauvegarde : <span id="lastCacheDate" class="font-medium"></span></p>
            <button id="btnRestoreCache" class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white text-sm font-medium rounded-lg transition-colors duration-200">
              <i class="fas fa-undo mr-2"></i>Restaurer
            </button>
          </div>
        </div>
      </div>
    </div>
    
    
    <!-- Section ADMINISTRATEUR -->
    <div>
      <div class="flex items-center gap-2 mb-4">
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
        <div class="flex items-center gap-2 px-4 py-2 bg-purple-50 rounded-full">
          <i class="fas fa-user-shield text-purple-600"></i>
          <span class="text-sm font-bold text-purple-700">ADMINISTRATEUR</span>
        </div>
        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
      </div>
      
      <div class="grid grid-cols-3 gap-4">
        <!-- Card FIN -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-purple-200 bg-gradient-to-br from-purple-50 to-purple-100 p-6 text-left transition-all duration-300 hover:border-purple-400 hover:shadow-xl hover:-translate-y-1" data-mode="FIN">
          <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="w-12 h-12 rounded-lg bg-purple-500 flex items-center justify-center shadow-lg mb-3 group-hover:scale-110 transition-transform duration-300">
              <i class="fas fa-check-circle text-xl text-white"></i>
            </div>
            <h3 class="text-base font-bold text-gray-800 mb-2">Répartition finalisée</h3>
            <p class="text-xs text-gray-600 mb-3">Corriger une répartition</p>
            <span class="inline-block px-2 py-1 bg-purple-500 text-white text-xs font-bold rounded">FIN</span>
          </div>
        </button>
        
        <!-- Card PREVIOUS -->
        <button class="mode-card group relative overflow-hidden rounded-xl border-2 border-gray-300 bg-gradient-to-br from-gray-50 to-gray-100 p-6 text-left transition-all duration-300 hover:border-gray-400 hover:shadow-xl hover:-translate-y-1" data-mode="PREVIOUS">
          <div class="absolute top-0 right-0 w-32 h-32 bg-gray-500/10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-500"></div>
          <div class="relative">
            <div class="w-12 h-12 rounded-lg bg-gray-700 flex items-center justify-center shadow-lg mb-3 group-hover:scale-110 transition-transform duration-300">
              <i class="fas fa-cog text-xl text-white"></i>
            </div>
            <h3 class="text-base font-bold text-gray-800 mb-2">Base admin</h3>
            <p class="text-xs text-gray-600 mb-3">Construire une nouvelle base</p>
            <span class="inline-block px-2 py-1 bg-gray-700 text-white text-xs font-bold rounded">CLASSES SOURCES</span>
          </div>
        </button>
        
        <!-- Card SOURCES (disabled) -->
        <button class="mode-card relative overflow-hidden rounded-xl border-2 border-gray-200 bg-gray-50 p-6 text-left opacity-50 cursor-not-allowed" data-mode="SOURCES" disabled>
          <div class="relative">
            <div class="w-12 h-12 rounded-lg bg-gray-300 flex items-center justify-center shadow mb-3">
              <i class="fas fa-database text-xl text-gray-500"></i>
            </div>
            <h3 class="text-base font-bold text-gray-600 mb-2">Base Pronote</h3>
            <p class="text-xs text-gray-500 mb-3">Non implémentée</p>
            <span class="inline-block px-2 py-1 bg-gray-300 text-gray-600 text-xs font-bold rounded">BIENTÔT</span>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Section Filtrer (clone de Paramètres > Filtres) -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="event.stopPropagation(); toggleSection('filtrer', this)">
      <span class="font-semibold text-gray-700"><i class="fas fa-filter mr-2"></i>Filtrer</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" data-section-icon="filtrer"></i>
    </button>
    <div data-section-id="filtrer" class="hidden px-4 pb-3" onclick="event.stopPropagation()">
      <div class="px-2 py-2 grid grid-cols-2 gap-1">
        <button class="filter-btn-compact" data-filter="all" onclick="doReglerFilter('all')">Tous</button>
        <button class="filter-btn-compact" data-filter="PERMUT" onclick="doReglerFilter('PERMUT')">PERMUT</button>
        <button class="filter-btn-compact" data-filter="FIXE" onclick="doReglerFilter('FIXE')">FIXE</button>
        <button class="filter-btn-compact" data-filter="ESP" onclick="doReglerFilter('ESP')">ESP</button>
        <button class="filter-btn-compact" data-filter="ITA" onclick="doReglerFilter('ITA')">ITA</button>
        <button class="filter-btn-compact" data-filter="ALL" onclick="doReglerFilter('ALL')">ALL</button>
        <button class="filter-btn-compact" data-filter="D" onclick="doReglerFilter('D')">Disso</button>
        <button class="filter-btn-compact" data-filter="A" onclick="doReglerFilter('A')">Asso</button>
      </div>
    </div>
  </div>

  <!-- Section Aide (clone) -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="event.stopPropagation(); toggleSection('aide', this)">
      <span class="font-semibold text-gray-700"><i class="fas fa-question-circle mr-2"></i>Aide</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" data-section-icon="aide"></i>
    </button>
    <div data-section-id="aide" class="hidden px-4 pb-3 space-y-2" onclick="event.stopPropagation()">
      <button class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" data-action="shortcuts" onclick="doReglerHelp('shortcuts')">
        <i class="fas fa-keyboard text-gray-600"></i>
        <span>Raccourcis</span>
      </button>
      <button class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" data-action="tutorial" onclick="doReglerHelp('tutorial')">
        <i class="fas fa-graduation-cap text-gray-600"></i>
        <span>Tutoriel</span>
      </button>
    </div>
  </div>
</div>

<!-- 2. BADGE DE MODE (indépendant) -->
<div id="modeBadge" class="fixed top-2 left-2 z-40 px-3 py-1 rounded-full font-bold text-xs shadow-lg hidden"></div>

<!-- 3. CONTENU PRINCIPAL DE L'APPLICATION (en dehors du modal) -->
<!-- Header moderne avec infos complètes -->
<header class="app-header px-6 py-3" role="banner" aria-label="Navigation principale">
  <div class="flex justify-between items-center">
    <!-- GAUCHE -->
    <div class="flex items-center gap-4">
      <!-- Logo -->
      <div>
        <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
          <i class="fas fa-graduation-cap text-purple-700"></i>
          Classes <span id="niveau-detected" class="text-purple-600"></span>
        </h1>
      </div>

      <!-- Recherche -->
      <div class="relative">
        <input id="search" type="text" placeholder="Rechercher..." class="search-input" aria-label="Rechercher un élève">
        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      </div>

      <!-- Boutons essentiels -->
      <div class="flex items-center gap-2">
        <label for="viewModeSelect" class="text-sm font-medium">Vue:</label>
        <select id="viewModeSelect" class="px-3 py-1 border rounded bg-white text-sm" title="Sélectionner le mode d'affichage">
          <option value="complete">Complète</option>
          <option value="essential">Essentielle</option>
          <option value="simple">Simple</option>
        </select>
      </div>

      <!-- Menu Régler (remplace Lisibilité + checkboxes) -->
      <div class="relative" id="menuReglerContainer">
        <button id="btnRegler" class="btn btn-secondary" title="Réglages d'affichage" aria-label="Ouvrir les réglages">
          <i class="fas fa-eye"></i> Régler
        </button>
        
        <!-- Dropdown menu déplacé en bas du body pour éviter stacking context -->
      </div>
      
      <!-- Menu Comparer (remplace Stats) -->
      <div class="relative" id="menuComparerContainer">
        <button id="btnComparer" class="btn btn-secondary" title="Statistiques et comparaisons" aria-label="Ouvrir le menu Comparer">
          <i class="fas fa-chart-bar"></i> Comparer
        </button>
        
        <!-- Dropdown menu déplacé en bas du body pour éviter stacking context -->
      </div>
      
      <!-- Menu Éditer (remplace Source et SWAP) -->
      <div class="relative" id="menuEditerContainer">
        <button id="btnEditer" class="btn btn-secondary" title="Actions d'édition" aria-label="Ouvrir le menu Éditer">
          <i class="fas fa-edit"></i> Éditer
        </button>
        
        <!-- Dropdown menu déplacé en bas du body pour éviter stacking context -->
      </div>
      
      <button id="btnSaveWIP" class="btn btn-secondary" title="Sauvegarder en brouillon (CACHE)">
        <i class="fas fa-save"></i> 💾 Brouillon
      </button>
    </div>

    <!-- DROITE -->
    <nav class="flex items-center gap-3" role="navigation" aria-label="Menus d'actions">
      <!-- FINALISER à gauche de Admin pour hiérarchie claire -->
      <button id="btnFinalize" class="btn btn-success" title="Finaliser les classes définitives">
        <i class="fas fa-check-circle"></i> ✅ FINALISER
      </button>
      
      <!-- Menu Admin (remplace Paramètres et Optimisation) -->
      <div class="relative" id="menuAdminContainer">
        <button id="btnAdmin" class="btn btn-secondary flex items-center gap-2" title="Menu administrateur (protégé par mot de passe)" aria-expanded="false" aria-haspopup="menu">
          <i class="fas fa-unlock-alt"></i> Admin <span id="adminStatusIndicator" class="text-xs ml-1 font-semibold">OFF</span>
        </button>
        
        <!-- Dropdown menu déplacé en bas du body pour éviter stacking context -->
      </div>
    </nav>
  </div>
</header>

<!-- Zone principale -->
<main class="w-full" role="main" aria-label="Répartition des élèves">
  <div id="board"></div>
</main>

<!-- Panneau de feedback en temps réel (pour les groupes uniquement) -->
<div id="feedbackPanel" class="feedback-panel" style="display: none;" role="complementary" aria-live="polite" aria-label="Statistiques en temps réel">
  <div class="feedback-header">
    <span><i class="fas fa-chart-line mr-2"></i>Indicateurs Groupes</span>
    <div class="flex gap-2">
      <button id="minimizeFeedback" class="text-white hover:text-yellow-200 transition-colors" aria-label="Réduire le panneau">
        <i class="fas fa-minus"></i>
      </button>
      <button id="closeFeedback" class="text-white hover:text-red-200 transition-colors" aria-label="Fermer le panneau">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="feedback-content">
    <div class="feedback-metric">
      <span class="metric-label">Équilibre F/M</span>
      <div class="metric-value" id="balanceMetric" aria-atomic="true">
        <span id="balanceValue">0.0</span>
        <div class="metric-change neutral" id="balanceChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Contraintes</span>
      <div class="metric-value" id="constraintsMetric" aria-atomic="true">
        <span id="constraintsValue">0</span>
        <div class="metric-change neutral" id="constraintsChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Diversité</span>
      <div class="metric-value" id="diversityMetric" aria-atomic="true">
        <span id="diversityValue">0.0</span>
        <div class="metric-change neutral" id="diversityChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Taille groupes</span>
      <div class="metric-value" id="sizeMetric" aria-atomic="true">
        <span id="sizeValue">0.0</span>
        <div class="metric-change neutral" id="sizeChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Équilibre scores</span>
      <div class="metric-value" id="scoresMetric" aria-atomic="true">
        <span id="scoresValue">0.0</span>
        <div class="metric-change neutral" id="scoresChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Mobilité</span>
      <div class="metric-value" id="mobilityMetric" aria-atomic="true">
        <span id="mobilityValue">0.0</span>
        <div class="metric-change neutral" id="mobilityChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
    <div class="feedback-metric">
      <span class="metric-label">Score global</span>
      <div class="metric-value" id="globalScoreMetric" aria-atomic="true">
        <span id="globalScoreValue">0.0</span>
        <div class="metric-change neutral" id="globalScoreChange">
          <i class="fas fa-minus"></i>
          <span>0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Panel historique (initialement caché) -->
<div id="historyPanel" class="history-panel">
  <div class="p-4 border-b">
    <h3 class="font-bold text-lg flex items-center justify-between">
      Historique des actions
      <button onclick="toggleHistoryPanel()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </h3>
  </div>
  <div id="historyTimeline" class="history-timeline"></div>
</div>

<!-- Menu bookmarks (dropdown) -->
<div class="relative">
  <div id="bookmarksMenu" class="bookmarks-menu">
    <div id="bookmarksList"></div>
    <div class="new-bookmark-form">
      <button class="btn btn-primary w-full" onclick="saveAsBookmark()">
        <i class="fas fa-plus"></i> Nouveau favori
      </button>
    </div>
  </div>
</div>

<!-- Panneau rétractable de lisibilité (initialement caché) -->
<div id="lisibilite-panel" class="fixed top-0 left-0 w-full bg-white shadow-lg z-50 transition-transform duration-300 transform -translate-y-full" style="padding: 24px 0 12px 0;">
  <div class="max-w-6xl mx-auto px-6">
    <div class="flex flex-row items-center justify-between mb-6">
      <div class="text-xl font-bold"><i class="fa fa-eye mr-2"></i>Options de lisibilité</div>
      <button id="close-lisibilite-panel" class="text-gray-500 hover:text-gray-800 text-2xl px-4 focus:outline-none" title="Fermer"><i class="fa fa-times"></i></button>
    </div>
    
    <!-- Options de lisibilité -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      
      <!-- Taille des noms -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Taille des noms</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite" data-size="small">Petite</button>
          <button class="btn-lisibilite active" data-size="medium">Moyenne</button>
          <button class="btn-lisibilite" data-size="large">Grande</button>
          <button class="btn-lisibilite" data-size="xlarge">Très grande</button>
        </div>
      </div>
      
      <!-- Style des noms -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Style des noms</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite active" data-style="normal">Normal</button>
          <button class="btn-lisibilite" data-style="bold">Gras</button>
          <button class="btn-lisibilite" data-style="highlight">Surligné</button>
          <button class="btn-lisibilite" data-style="outline">Encadré</button>
        </div>
      </div>
      
      <!-- Contraste -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Contraste</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite active" data-contrast="normal">Normal</button>
          <button class="btn-lisibilite" data-contrast="high">Élevé</button>
          <button class="btn-lisibilite" data-contrast="max">Maximum</button>
        </div>
      </div>
      
      <!-- Symboles genres -->
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Affichage genres</h3>
        <div class="space-y-2">
          <button class="btn-lisibilite active" data-symbols="colors">Couleurs</button>
          <button class="btn-lisibilite" data-symbols="symbols">Symboles</button>
          <button class="btn-lisibilite" data-symbols="both">Couleurs + Symboles</button>
        </div>
      </div>
      
    </div>

    <!-- Cases à cocher pour affichage -->
    <div class="mt-6">
      <div class="bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold mb-3 text-gray-800">Éléments à afficher</h3>
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-100 p-2 rounded transition-colors">
            <input type="checkbox" id="toggle-prenoms" checked class="h-4 w-4 rounded accent-purple-600">
            <span>Afficher les prénoms</span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-100 p-2 rounded transition-colors">
            <input type="checkbox" id="toggle-classe" checked class="h-4 w-4 rounded accent-purple-600">
            <span>Afficher la classe d'origine</span>
          </label>
          <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-100 p-2 rounded transition-colors">
            <input type="checkbox" id="toggle-scores" checked class="h-4 w-4 rounded accent-purple-600">
            <span>Afficher les badges de scores</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Boutons d'action -->
    <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-200">
      <button id="reset-lisibilite" class="btn btn-secondary">
        <i class="fas fa-undo"></i> Réinitialiser
      </button>
      <button id="fullscreen-mode" class="btn btn-primary">
        <i class="fas fa-expand"></i> Mode plein écran
      </button>
    </div>
  </div>
</div>

<!-- TEMPLATES - À PLACER JUSTE AVANT LA FIN DU BODY -->
<template id="tpl-carte-eleve">
  <div class="student-card" draggable="true" data-id="">
    <div class="card-content-line">
      
      <div class="student-fullname"></div>
      <div class="all-badges"></div>
      <div class="source-class text-xs font-medium text-gray-700"></div>
      <div class="scores"></div>
      <div class="badge-dispo-container"></div>
    </div>
  </div>
</template>

<template id="tpl-classe-col">
  <div class="class-column fade-in">
    <div class="class-header">
      <div class="class-title-line">
        <h2 class="classe-name"></h2>
        <div class="class-counts">
          <span><i class="fas fa-users opacity-75"></i> <span class="count font-bold">0</span></span>
          <span class="text-pink-200"><i class="fas fa-venus"></i> <span class="count-f font-bold">0</span></span>
          <span class="text-blue-200"><i class="fas fa-mars"></i> <span class="count-m font-bold">0</span></span>
        </div>
      </div>
      <div class="sort-buttons">
        <button class="sort-btn" data-sort="name" title="Trier par nom (A→Z ou Z→A)">
          <span class="sort-label">ABC</span>
          <span class="sort-arrow">⇅</span>
        </button>
        <button class="sort-btn" data-sort="lv2" title="Trier par langue (ESP→ITA→ALL→LATIN→GRECO)">
          <span class="sort-label">LV2</span>
          <span class="sort-arrow">⇅</span>
        </button>
        <button class="sort-btn" data-sort="option" title="Trier par option (alphabétique)">
          <span class="sort-label">OPT</span>
          <span class="sort-arrow">⇅</span>
        </button>
        <button class="sort-btn" data-sort="score" title="Trier par comportement (🟩 Vert=meilleurs en haut ↑ / 🔴 Rouge=pires en haut ↓)">
          <span class="sort-label">COM</span>
          <span class="sort-arrow">⇅</span>
        </button>
      </div>
    </div>
    <div class="droppable-zone" data-classe=""></div>
  </div>
</template>

<!-- OVERLAY et MODALES (si absents, à compléter selon besoin) -->
<div id="overlay" class="overlay hidden"></div>

<!-- Modal Export -->
<div id="exportModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-xl font-bold">Exporter la répartition</h2>
      <button onclick="closeExportModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="grid grid-cols-2 gap-4">
        <button onclick="exportExcel()" class="btn btn-primary">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
        <button onclick="exportPDF()" class="btn btn-primary">
          <i class="fas fa-file-pdf"></i> Export PDF
        </button>
        <button onclick="exportAsImage()" class="btn btn-primary">
          <i class="fas fa-camera"></i> Export Image (PNG)
        </button>
        <button onclick="showComparison()" class="btn btn-secondary">
          <i class="fas fa-exchange-alt"></i> Comparer avant/après
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Règles -->
<div id="rulesModal" class="modal hidden">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="text-xl font-bold">Éditer les règles de répartition</h2>
      <button onclick="closeRulesModal()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="rulesContainer"></div>
    </div>
    <div class="modal-footer">
      <button onclick="closeRulesModal()" class="btn btn-secondary">Annuler</button>
      <button onclick="saveRules()" class="btn btn-primary">Sauvegarder</button>
    </div>
  </div>
</div>

<!-- Panneau Statistiques -->
<div id="statsPanel" class="fixed top-0 right-0 h-full bg-white shadow-xl transform translate-x-full transition-transform duration-300 stats-panel">
  <div class="stats-panel-header">
    <h2 class="text-lg font-bold">Statistiques détaillées</h2>
    <div class="flex gap-2">
      <button id="btnFullscreen" class="btn btn-sm" onclick="toggleFullscreenStats()">
        <i class="fas fa-expand"></i>
      </button>
      <button id="btnAnchor" class="btn btn-sm" onclick="toggleAnchoredStats()">
        <i class="fas fa-thumbtack"></i>
      </button>
      <button id="closeStats" class="btn btn-sm">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div id="statsContent" class="p-4 overflow-y-auto" style="height: calc(100% - 60px);">
    <!-- Le contenu sera généré dynamiquement -->
  </div>
</div>

<!-- Aide clavier -->
<div id="keyboardShortcuts" class="keyboard-shortcuts hidden">
  <h4>Raccourcis clavier</h4>
  <div class="grid grid-cols-2 gap-2 text-xs">
    <div class="shortcut-item"><span>Recherche</span><span class="shortcut-key">Ctrl+F</span></div>
    <div class="shortcut-item"><span>Actualiser</span><span class="shortcut-key">F5</span></div>
    <div class="shortcut-item"><span>Annuler</span><span class="shortcut-key">Ctrl+Z</span></div>
    <div class="shortcut-item"><span>Refaire</span><span class="shortcut-key">Ctrl+Y</span></div>
    <div class="shortcut-item"><span>Mode swap</span><span class="shortcut-key">S</span></div>
    <div class="shortcut-item"><span>Statistiques</span><span class="shortcut-key">T</span></div>
    <div class="shortcut-item"><span>Mode sombre</span><span class="shortcut-key">D</span></div>
    <div class="shortcut-item"><span>Vue simple</span><span class="shortcut-key">V</span></div>
    <div class="shortcut-item"><span>Tutoriel</span><span class="shortcut-key">H</span></div>
    <div class="shortcut-item"><span>Fermer modals</span><span class="shortcut-key">Échap</span></div>
    </div>
</div>

  <!-- Scripts HtmlService injectés en fin de document pour garantir leur exécution après le chargement du DOM -->
  
  <!-- 1. CHARGER LES MODULES DE BASE EN PREMIER (Config, State, Utils, Toast, Spinner) -->
  <?!= include('InterfaceV2_Modules_Loader'); ?>
  
  <!-- 2. CHARGER LE SCRIPT PRINCIPAL (qui dépend des modules de base) -->
  <?!= include('InterfaceV2_CoreScript'); ?>

  <?!= include('InterfaceV2_StatsCleanupScript'); ?>
  
  <!-- 3. CHARGER LES MODULES UI AVANCÉS (Tooltips, Raccourcis, Validation, etc.) -->
  <?!= include('InterfaceV2_UIModules_Loader'); ?>
  
  <!-- 3.5 CHARGER LES RACCOURCIS CLAVIER (T/V/H) -->
  <?!= include('KeyboardShortcuts'); ?>
  
  <!-- 4. CHARGER LE MODULE D'OPTIMISATION -->
  <?!= include('OptimizationPanel'); ?>

<!-- Menu Paramètres SUPPRIMÉ - Tout le contenu est maintenant dans le Menu Admin -->

<!-- Menu Régler (déplacé ici pour éviter stacking context du header) -->
<div id="dropdownRegler" data-menu-root class="fixed w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-[100000] hidden" style="max-height: 80vh; overflow-y: auto;">
  
  <!-- Section Lisibilité -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('lisibiliteSection')">
      <span class="font-semibold text-gray-700"><i class="fas fa-text-height mr-2"></i>Lisibilité</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" id="lisibiliteSectionIcon"></i>
    </button>
    <div id="lisibiliteSection" class="px-4 pb-3 space-y-3">
      
      <!-- Checkboxes -->
      <div class="space-y-2">
        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
          <input type="checkbox" id="showGenderBadges" class="w-4 h-4 cursor-pointer">
          <span>Badges sexe</span>
        </label>
        <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
          <input type="checkbox" id="whiteBackground" class="w-4 h-4 cursor-pointer">
          <span>Fond blanc</span>
        </label>
      </div>
      
      <!-- Taille des noms -->
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase mb-2 block">Taille des noms</label>
        <div class="grid grid-cols-4 gap-2">
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-size="small">
            <input type="radio" name="fontSize" value="small" class="hidden">
            <span class="text-sm font-medium">S</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors bg-blue-50 border-blue-500" data-size="medium">
            <input type="radio" name="fontSize" value="medium" class="hidden" checked>
            <span class="text-sm font-medium text-blue-700">M</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-size="large">
            <input type="radio" name="fontSize" value="large" class="hidden">
            <span class="text-sm font-medium">L</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-size="xlarge">
            <input type="radio" name="fontSize" value="xlarge" class="hidden">
            <span class="text-sm font-medium">XL</span>
          </label>
        </div>
      </div>
      
      <!-- Style -->
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase mb-2 block">Style</label>
        <div class="grid grid-cols-2 gap-2">
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors bg-blue-50 border-blue-500" data-style="normal">
            <input type="radio" name="fontStyle" value="normal" class="hidden" checked>
            <span class="text-sm font-medium text-blue-700">Normal</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-style="bold">
            <input type="radio" name="fontStyle" value="bold" class="hidden">
            <span class="text-sm font-medium">Gras</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-style="highlight">
            <input type="radio" name="fontStyle" value="highlight" class="hidden">
            <span class="text-sm font-medium">Surligné</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-style="outline">
            <input type="radio" name="fontStyle" value="outline" class="hidden">
            <span class="text-sm font-medium">Contour</span>
          </label>
        </div>
      </div>
      
      <!-- Contraste -->
      <div>
        <label class="text-xs font-semibold text-gray-500 uppercase mb-2 block">Contraste</label>
        <div class="grid grid-cols-3 gap-2">
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors bg-blue-50 border-blue-500" data-contrast="normal">
            <input type="radio" name="contrast" value="normal" class="hidden" checked>
            <span class="text-sm font-medium text-blue-700">Normal</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-contrast="high">
            <input type="radio" name="contrast" value="high" class="hidden">
            <span class="text-sm font-medium">Élevé</span>
          </label>
          <label class="flex items-center justify-center px-3 py-2 border rounded cursor-pointer hover:bg-gray-50 transition-colors" data-contrast="max">
            <input type="radio" name="contrast" value="max" class="hidden">
            <span class="text-sm font-medium">Maximum</span>
          </label>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- Section Afficher -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('afficherSection')">
      <span class="font-semibold text-gray-700"><i class="fas fa-list mr-2"></i>Afficher</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" id="afficherSectionIcon"></i>
    </button>
    <div id="afficherSection" class="px-4 pb-3 space-y-2">
      <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
        <input type="checkbox" id="showPrenoms" class="w-4 h-4 cursor-pointer" checked>
        <span>Prénoms</span>
      </label>
      <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
        <input type="checkbox" id="showClasseOrigine" class="w-4 h-4 cursor-pointer" checked>
        <span>Classe d'origine</span>
      </label>
      <label class="flex items-center gap-2 text-sm cursor-pointer hover:bg-gray-50 p-2 rounded">
        <input type="checkbox" id="showScores" class="w-4 h-4 cursor-pointer" checked>
        <span>Scores</span>
      </label>
    </div>
  </div>
  
  <!-- Actions simples -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" id="btnPleinEcran">
      <i class="fas fa-expand text-gray-600"></i>
      <span class="text-sm font-medium">Plein écran</span>
    </button>
    <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" id="btnModeSombre">
      <i class="fas fa-moon text-gray-600"></i>
      <span class="text-sm font-medium">Mode sombre</span>
    </button>
    <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" id="btnZoomCartes">
      <i class="fas fa-search-plus text-gray-600"></i>
      <span class="text-sm font-medium">Zoom cartes</span>
    </button>
  </div>
  
  <!-- Section Préréglages -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('prereglagesSection')">
      <span class="font-semibold text-gray-700"><i class="fas fa-magic mr-2"></i>Préréglages</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" id="prereglagesSectionIcon"></i>
    </button>
    <div id="prereglagesSection" class="hidden px-4 pb-3 space-y-2">
      <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left rounded" id="presetProjection">
        <i class="fas fa-tv text-blue-600"></i>
        <span class="text-sm font-medium">Mode Projection</span>
      </button>
      <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left rounded" id="presetImpression">
        <i class="fas fa-print text-green-600"></i>
        <span class="text-sm font-medium">Mode Impression</span>
      </button>
      <button class="w-full px-3 py-2 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left rounded" id="presetAccessibilite">
        <i class="fas fa-universal-access text-purple-600"></i>
        <span class="text-sm font-medium">Mode Accessibilité</span>
      </button>
    </div>
  </div>
  
  <!-- Section Filtrer (clone de Paramètres > Filtres) -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('filtrerSection')">
      <span class="font-semibold text-gray-700"><i class="fas fa-filter mr-2"></i>Filtrer</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" id="filtrerSectionIcon"></i>
    </button>
    <div id="filtrerSection" class="hidden px-4 pb-3">
      <div class="px-2 py-2 grid grid-cols-2 gap-1">
        <button class="filter-btn-compact" data-filter="all" onclick="doReglerFilter('all')">Tous</button>
        <button class="filter-btn-compact" data-filter="PERMUT" onclick="doReglerFilter('PERMUT')">PERMUT</button>
        <button class="filter-btn-compact" data-filter="FIXE" onclick="doReglerFilter('FIXE')">FIXE</button>
        <button class="filter-btn-compact" data-filter="ESP" onclick="doReglerFilter('ESP')">ESP</button>
        <button class="filter-btn-compact" data-filter="ITA" onclick="doReglerFilter('ITA')">ITA</button>
        <button class="filter-btn-compact" data-filter="ALL" onclick="doReglerFilter('ALL')">ALL</button>
        <button class="filter-btn-compact" data-filter="D" onclick="doReglerFilter('D')">Disso</button>
        <button class="filter-btn-compact" data-filter="A" onclick="doReglerFilter('A')">Asso</button>
      </div>
    </div>
  </div>

  <!-- Section Aide (clone) -->
  <div class="border-b border-gray-100">
    <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('aideReglerSection')">
      <span class="font-semibold text-gray-700"><i class="fas fa-question-circle mr-2"></i>Aide</span>
      <i class="fas fa-chevron-down text-gray-400 transition-transform" id="aideReglerSectionIcon"></i>
    </button>
    <div id="aideReglerSection" class="hidden px-4 pb-3 space-y-2">
      <button class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" onclick="doReglerHelp('shortcuts')">
        <i class="fas fa-keyboard text-gray-600"></i>
        <span>Raccourcis</span>
      </button>
      <button class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" onclick="doReglerHelp('tutorial')">
        <i class="fas fa-graduation-cap text-gray-600"></i>
        <span>Tutoriel</span>
      </button>
    </div>
  </div>
  
  
  <!-- Réinitialiser -->
  <div>
    <button class="w-full px-4 py-3 flex items-center gap-3 hover:bg-red-50 transition-colors text-left text-red-600" id="btnResetReglages">
      <i class="fas fa-undo"></i>
      <span class="text-sm font-medium">Réinitialiser les réglages</span>
    </button>
  </div>
  
</div>
<!-- FIN Menu Régler -->

<!-- Menu Éditer (déplacé ici pour éviter stacking context du header) -->
<div id="dropdownEditer" class="fixed w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-[100000] hidden" style="max-height: 80vh; overflow-y: auto;">
  
  <!-- Mode Permutation -->
  <div class="border-b border-gray-100">
    <button id="btnSwapMainMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Activer le mode permutation d'élèves">
      <i class="fas fa-exchange-alt text-gray-600"></i>
      <span class="text-sm font-medium">Mode Permutation</span>
      <span id="swapModeIndicator" class="ml-auto text-xs px-2 py-1 rounded bg-gray-200 text-gray-600">OFF</span>
    </button>
  </div>
  
  <!-- Actions Annuler/Rétablir -->
  <div class="border-b border-gray-100">
    <div class="flex gap-1 px-2 py-2">
      <button id="btnUndoMenu" class="flex-1 px-3 py-2 flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors rounded border border-gray-200" disabled title="Annuler la dernière action (Ctrl+Z)">
        <i class="fas fa-undo text-gray-600"></i>
        <span class="text-sm font-medium">Annuler</span>
      </button>
      <button id="btnRedoMenu" class="flex-1 px-3 py-2 flex items-center justify-center gap-2 hover:bg-gray-50 transition-colors rounded border border-gray-200" disabled title="Rétablir l'action annulée (Ctrl+Y)">
        <i class="fas fa-redo text-gray-600"></i>
        <span class="text-sm font-medium">Rétablir</span>
      </button>
    </div>
  </div>
  
  <!-- Historique -->
  <div class="border-b border-gray-100">
    <button id="btnHistoryMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Afficher l'historique des actions">
      <i class="fas fa-history text-gray-600"></i>
      <span class="text-sm font-medium">Historique</span>
    </button>
  </div>
  
  <!-- Sources -->
  <div>
    <button id="btnSourcesMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Choisir la source de données">
      <i class="fas fa-database text-gray-600"></i>
      <span class="text-sm font-medium">Sources</span>
    </button>
  </div>
  
</div>
<!-- FIN Menu Éditer -->

<!-- Menu Comparer (déplacé ici pour éviter stacking context du header) -->
<div id="dropdownComparer" class="fixed w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-[100000] hidden" style="max-height: 80vh; overflow-y: auto;">
  
  <!-- Statistiques (ouvre le panneau stats) -->
  <div class="border-b border-gray-100">
    <button id="btnStatsMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Afficher le panneau de statistiques">
      <i class="fas fa-chart-bar text-gray-600"></i>
      <span class="text-sm font-medium">Statistiques</span>
    </button>
  </div>
  
  <!-- Tableaux de bord analytiques -->
  <div>
    <button id="btnAnalyticsMenu" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Ouvrir les tableaux de bord analytiques">
      <i class="fas fa-chart-line text-gray-600"></i>
      <span class="text-sm font-medium">Tableaux de bord analytiques</span>
    </button>
  </div>
  
</div>
<!-- FIN Menu Comparer -->

<!-- Menu Admin (déplacé ici pour éviter stacking context du header) -->
<div id="dropdownAdmin" data-menu-root class="fixed w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-[100000] hidden transition-all duration-200 ease-out opacity-0 scale-95" style="max-height: 80vh; overflow-y: auto; transform-origin: top right;">
  
  <!-- Message de verrouillage (affiché si non déverrouillé) -->
  <div id="adminLockMessage" class="px-4 py-6">
    <div class="text-center mb-4">
      <i class="fas fa-lock text-4xl text-gray-400 mb-3"></i>
      <p class="text-sm text-gray-600">Ce menu est protégé par mot de passe</p>
    </div>
    
    <!-- Champ de saisie du mot de passe -->
    <div class="space-y-3">
      <div class="relative">
        <input 
          type="password" 
          id="adminPasswordInput" 
          placeholder="Entrez le mot de passe administrateur"
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none text-sm"
          autocomplete="off"
        >
        <button 
          id="btnTogglePasswordVisibility" 
          type="button"
          class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
          title="Afficher/Masquer le mot de passe"
        >
          <i class="fas fa-eye"></i>
        </button>
      </div>
      
      <button id="btnUnlockAdmin" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
        <i class="fas fa-unlock-alt mr-2"></i>Déverrouiller
      </button>
      
      <p id="adminPasswordError" class="text-xs text-red-600 text-center hidden">
        <i class="fas fa-exclamation-circle mr-1"></i>Mot de passe incorrect
      </p>
    </div>
  </div>
  
  <!-- Contenu Admin (affiché après déverrouillage) -->
  <div id="adminContent" class="hidden">
    
    <!-- Bouton Verrouiller -->
    <div class="border-b border-gray-100 bg-red-50">
      <button id="btnLockAdmin" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-red-100 transition-colors text-left">
        <i class="fas fa-lock text-red-600"></i>
        <span class="text-sm font-semibold text-red-700">🔒 Verrouiller le menu Admin</span>
      </button>
    </div>
    
    <!-- Mode Admin Force (déplacer n'importe quel élève sans contraintes) -->
    <div class="border-b border-gray-100 bg-amber-50">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="fas fa-user-shield text-amber-600"></i>
          <div>
            <div class="text-sm font-semibold text-gray-800">Mode Force</div>
            <div class="text-xs text-gray-600">Ignorer toutes les contraintes (FIXE, PERMUT, CONDI)</div>
          </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="toggleAdminForceMode" class="sr-only peer">
          <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-600"></div>
        </label>
      </div>
    </div>
    
    <!-- Sources -->
    <div class="border-b border-gray-100">
      <button id="btnSourcesAdmin" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Choisir la source de données">
        <i class="fas fa-database text-gray-600"></i>
        <span class="text-sm font-medium">Sources</span>
      </button>
    </div>
    
    <!-- Optimisation -->
    <div class="border-b border-gray-100">
      <button id="btnOptimizationAdmin" class="w-full px-4 py-3 flex items-center gap-3 hover:bg-gray-50 transition-colors text-left" title="Optimisation automatique">
        <i class="fas fa-magic text-gray-600"></i>
        <span class="text-sm font-medium">Optimisation</span>
      </button>
    </div>
    
    <!-- Groupes -->
    <div class="border-b border-gray-100">
      <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('groupesSection')">
        <div class="flex items-center gap-3">
          <i class="fas fa-layer-group text-gray-600"></i>
          <span class="text-sm font-medium">Groupes</span>
        </div>
        <i class="fas fa-chevron-down text-gray-400 transition-transform" id="groupesSectionIcon"></i>
      </button>
      <div id="groupesSection" class="hidden px-4 pb-3 space-y-2">
        <label class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm cursor-pointer">
          <input type="checkbox" id="adminToggleHeaderGroups" class="h-4 w-4">
          <span>Afficher le bouton Groupes dans le header</span>
        </label>
        <button id="menuOpenGroupsAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" onclick="openGroupsInterface('creator')">
          <i class="fas fa-plus-circle text-gray-600"></i>
          <span>Créer des groupes</span>
        </button>
        <button id="menuManageGroupsAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm" onclick="openGroupsInterface('manager')">
          <i class="fas fa-cog text-gray-600"></i>
          <span>Gérer les groupes</span>
        </button>
      </div>
    </div>
    
    <!-- Paramètres (tout le contenu actuel) -->
    <div>
      <button class="w-full px-4 py-3 flex items-center justify-between hover:bg-gray-50 transition-colors" onclick="toggleSection('parametresSection')">
        <div class="flex items-center gap-3">
          <i class="fas fa-cog text-gray-600"></i>
          <span class="text-sm font-medium">Paramètres</span>
        </div>
        <i class="fas fa-chevron-down text-gray-400 transition-transform" id="parametresSectionIcon"></i>
      </button>
      <div id="parametresSection" class="hidden px-2 pb-3">
        
        <!-- Affichage -->
        <div class="mb-2">
          <div class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase">Affichage</div>
          <button id="menuDarkModeAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-moon text-gray-600"></i>
            <span>Mode sombre</span>
          </button>
          <button id="menuZoomAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-search-plus text-gray-600"></i>
            <span>Zoom cartes</span>
          </button>
          <button id="menuFullscreenAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-expand text-gray-600"></i>
            <span>Plein écran</span>
          </button>
        </div>
        
        <!-- Données -->
        <div class="mb-2">
          <div class="px-2 py-1 text-xs font-semibold text-gray-500 uppercase">Données</div>
          <button id="menuImportScoresAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-upload text-gray-600"></i>
            <span>Import Scores</span>
          </button>
          <button id="btnExportAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-download text-gray-600"></i>
            <span>Export</span>
          </button>
          <button id="menuRulesAdmin" class="w-full px-3 py-2 flex items-center gap-2 hover:bg-gray-50 transition-colors rounded text-left text-sm">
            <i class="fas fa-edit text-gray-600"></i>
            <span>Règles</span>
          </button>
        </div>
        
        <!-- FILTRES et AIDE supprimés du menu Admin (déjà présents dans Régler) -->
        
      </div>
    </div>
    
  </div>
  
</div>
<!-- FIN Menu Admin -->

<!-- ========== INCLUSION DU MODULE COMPLET DE GROUPES (GOOGLE APPS SCRIPT) ========== -->
<?!= include('groupsModuleComplete'); ?>

  <?!= include('InterfaceV2_GroupsScript'); ?>

<!-- ============================================================ -->
<!-- TOOLTIPS SYSTEM -->
<!-- ============================================================ -->
<?!= include('TooltipRegistry'); ?>

<!-- ============================================================ -->
<!-- FONCTION D'OUVERTURE DU MODULE ANALYTIQUE -->
<!-- ============================================================ -->
<script>
/**
 * Ouvre le module de tableaux de bord analytiques
 */
function openAnalyticsDashboard() {
  console.log('📈 Ouverture des tableaux de bord analytiques...');
  
  // Retirer le focus du bouton avant de fermer le menu (accessibilité)
  if (document.activeElement) {
    document.activeElement.blur();
  }
  
  // Fermer le menu Paramètres
  const dropdown = document.getElementById('settingsDropdown');
  if (dropdown) {
    dropdown.classList.add('hidden');
    dropdown.setAttribute('aria-hidden', 'true');
  }
  
  // Afficher un spinner
  const spinner = document.getElementById('loadingSpinner');
  if (spinner) spinner.classList.remove('hidden');
  
  // Charger le snapshot analytique
  google.script.run
    .withSuccessHandler(function(snapshot) {
      if (spinner) spinner.classList.add('hidden');
      
      console.log('✅ Snapshot reçu:', snapshot);
      
      // getAnalyticsSnapshotForUI() retourne directement le snapshot
      if (snapshot && snapshot.timestamp) {
        // Afficher le dashboard dans un modal
        showAnalyticsDashboard(snapshot);
      } else {
        console.error('❌ Snapshot invalide:', snapshot);
        toast('Erreur: Données analytiques invalides', 'error');
      }
    })
    .withFailureHandler(function(error) {
      if (spinner) spinner.classList.add('hidden');
      console.error('❌ Erreur chargement analytics:', error);
      toast('Erreur: ' + error.message, 'error');
    })
    .getAnalyticsSnapshotForUI();
}

/**
 * Affiche le dashboard analytique dans un modal
 */
function showAnalyticsDashboard(snapshot) {
  console.log('📊 Affichage du dashboard analytique:', snapshot);
  
  // Créer le modal
  const modal = document.createElement('div');
  modal.id = 'analyticsDashboardModal';
  modal.className = 'fixed inset-0 z-[10000] flex items-center justify-center bg-black bg-opacity-60';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl w-11/12 h-5/6 max-w-7xl overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold">📊 Tableaux de bord analytiques</h2>
          <p class="text-purple-100 text-sm mt-1">Snapshot du ${new Date(snapshot.timestamp).toLocaleString('fr-FR')}</p>
        </div>
        <button onclick="closeAnalyticsDashboard()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="border-b border-gray-200 bg-gray-50 px-6">
        <div class="flex gap-4">
          <button class="analytics-tab active" data-view="overview" onclick="switchAnalyticsView('overview')">
            <i class="fas fa-chart-pie"></i> Vue d'ensemble
          </button>
          <button class="analytics-tab" data-view="classes" onclick="switchAnalyticsView('classes')">
            <i class="fas fa-users"></i> Par classe
          </button>
          <button class="analytics-tab" data-view="risks" onclick="switchAnalyticsView('risks')">
            <i class="fas fa-exclamation-triangle"></i> Zones de risque
          </button>
          <button class="analytics-tab" data-view="history" onclick="switchAnalyticsView('history')">
            <i class="fas fa-history"></i> Historique
          </button>
        </div>
      </div>
      
      <!-- Content -->
      <div class="flex-1 overflow-auto p-6" id="analyticsContent">
        ${renderAnalyticsOverview(snapshot)}
      </div>
      
      <!-- Footer -->
      <div class="border-t border-gray-200 bg-gray-50 p-4 flex justify-between items-center">
        <div class="text-sm text-gray-600">
          <i class="fas fa-info-circle"></i> Pipeline: ${snapshot.pipeline || 'N/A'} | Mode: ${snapshot.config?.mode?.selected || 'N/A'}
        </div>
        <div class="flex gap-2">
          <button onclick="exportAnalyticsPDF()" class="btn btn-secondary">
            <i class="fas fa-file-pdf"></i> Export PDF
          </button>
          <button onclick="exportAnalyticsCSV()" class="btn btn-secondary">
            <i class="fas fa-file-csv"></i> Export CSV
          </button>
        </div>
      </div>
    </div>
  `;
  
  // Ajouter les styles pour les tabs
  const style = document.createElement('style');
  style.textContent = `
    .analytics-tab {
      padding: 1rem 1.5rem;
      border-bottom: 3px solid transparent;
      color: #6B7280;
      font-weight: 500;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      cursor: pointer;
    }
    .analytics-tab:hover {
      color: #4F46E5;
      background: rgba(79, 70, 229, 0.05);
    }
    .analytics-tab.active {
      color: #4F46E5;
      border-bottom-color: #4F46E5;
      background: white;
    }
    .metric-card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #E5E7EB;
    }
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      color: #1F2937;
    }
    .metric-label {
      font-size: 0.875rem;
      color: #6B7280;
      margin-top: 0.25rem;
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(modal);
  
  // Stocker le snapshot pour les autres vues
  window.currentAnalyticsSnapshot = snapshot;
}

/**
 * Render la vue d'ensemble
 */
function renderAnalyticsOverview(snapshot) {
  const global = snapshot.global || {};
  const risks = snapshot.risks || [];
  const recommendations = snapshot.recommendations || [];
  
  return `
    <div class="space-y-6">
      <!-- Métriques globales -->
      <div class="grid grid-cols-4 gap-4">
        <div class="metric-card">
          <div class="metric-value">${global.totalEleves || 0}</div>
          <div class="metric-label">Élèves total</div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${global.pariteGlobale?.toFixed(1) || 0}%</div>
          <div class="metric-label">Parité F/M</div>
          <div class="text-xs mt-1 ${global.pariteRespecteePartout ? 'text-green-600' : 'text-orange-600'}">
            <i class="fas fa-${global.pariteRespecteePartout ? 'check' : 'exclamation-triangle'}"></i>
            ${global.pariteRespecteePartout ? 'Respectée partout' : 'Non respectée'}
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-value">${global.varianceEffectifs?.toFixed(2) || 0}</div>
          <div class="metric-label">Variance effectifs</div>
          <div class="text-xs mt-1 text-gray-600">
            <i class="fas fa-info-circle"></i> Plus c'est bas, mieux c'est
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-value ${global.quotasRespectesPartout ? 'text-green-600' : 'text-orange-600'}">
            <i class="fas fa-${global.quotasRespectesPartout ? 'check-circle' : 'exclamation-circle'}"></i>
          </div>
          <div class="metric-label">Quotas</div>
          <div class="text-xs mt-1">
            ${global.quotasRespectesPartout ? 'Tous respectés' : 'Dépassements détectés'}
          </div>
        </div>
      </div>
      
      <!-- Zones de risque -->
      ${risks.length > 0 ? `
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-orange-800 mb-3">
            <i class="fas fa-exclamation-triangle"></i> Zones de risque (${risks.length})
          </h3>
          <div class="space-y-2">
            ${risks.slice(0, 5).map(risk => `
              <div class="flex items-start gap-3 bg-white p-3 rounded border border-orange-200">
                <div class="flex-shrink-0">
                  <span class="inline-block px-2 py-1 text-xs font-semibold rounded ${
                    risk.severity === 'HIGH' ? 'bg-red-100 text-red-800' : 'bg-orange-100 text-orange-800'
                  }">
                    ${risk.severity}
                  </span>
                </div>
                <div class="flex-1">
                  <div class="font-medium text-gray-900">${risk.classe}</div>
                  <div class="text-sm text-gray-600">${risk.message}</div>
                </div>
              </div>
            `).join('')}
            ${risks.length > 5 ? `<div class="text-sm text-gray-600 text-center mt-2">... et ${risks.length - 5} autre(s)</div>` : ''}
          </div>
        </div>
      ` : `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
          <i class="fas fa-check-circle text-green-600 text-3xl mb-2"></i>
          <div class="text-green-800 font-semibold">Aucune zone de risque détectée</div>
          <div class="text-green-600 text-sm mt-1">Toutes les contraintes sont respectées</div>
        </div>
      `}
      
      <!-- Recommandations -->
      ${recommendations.length > 0 ? `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h3 class="text-lg font-semibold text-blue-800 mb-3">
            <i class="fas fa-lightbulb"></i> Recommandations (${recommendations.length})
          </h3>
          <div class="space-y-2">
            ${recommendations.slice(0, 5).map(rec => `
              <div class="flex items-start gap-3 bg-white p-3 rounded border border-blue-200">
                <div class="flex-shrink-0 text-blue-600">
                  <i class="fas fa-arrow-right"></i>
                </div>
                <div class="flex-1">
                  <div class="font-medium text-gray-900">${rec.classe}</div>
                  <div class="text-sm text-gray-600">${rec.action}</div>
                </div>
              </div>
            `).join('')}
            ${recommendations.length > 5 ? `<div class="text-sm text-gray-600 text-center mt-2">... et ${recommendations.length - 5} autre(s)</div>` : ''}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

/**
 * Ferme le dashboard analytique
 */
function closeAnalyticsDashboard() {
  const modal = document.getElementById('analyticsDashboardModal');
  if (modal) {
    modal.remove();
  }
  window.currentAnalyticsSnapshot = null;
}

/**
 * Change de vue dans le dashboard
 */
function switchAnalyticsView(view) {
  // Mettre à jour les tabs
  document.querySelectorAll('.analytics-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.view === view);
  });
  
  // Afficher le contenu correspondant
  const content = document.getElementById('analyticsContent');
  const snapshot = window.currentAnalyticsSnapshot;
  
  if (!snapshot) {
    content.innerHTML = '<div class="text-center text-gray-500">Aucune donnée disponible</div>';
    return;
  }
  
  switch(view) {
    case 'overview':
      content.innerHTML = renderAnalyticsOverview(snapshot);
      break;
    case 'classes':
      content.innerHTML = renderAnalyticsClasses(snapshot);
      break;
    case 'risks':
      content.innerHTML = renderAnalyticsRisks(snapshot);
      break;
    case 'history':
      loadAnalyticsHistory();
      break;
  }
}

/**
 * Render la vue par classe
 */
function renderAnalyticsClasses(snapshot) {
  const classes = snapshot.classes || {};
  
  return `
    <div class="grid grid-cols-2 gap-4">
      ${Object.keys(classes).map(classe => {
        const data = classes[classe];
        return `
          <div class="metric-card">
            <h3 class="text-lg font-semibold mb-3">${classe}</h3>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <div>
                <div class="text-gray-600">Effectif</div>
                <div class="font-semibold">${data.effectif || 0} / ${data.target || 0}</div>
                <div class="text-xs ${data.gapToTarget > 0 ? 'text-green-600' : data.gapToTarget < 0 ? 'text-orange-600' : 'text-gray-500'}">
                  ${data.gapToTarget > 0 ? '+' : ''}${data.gapToTarget || 0}
                </div>
              </div>
              <div>
                <div class="text-gray-600">Parité F/M</div>
                <div class="font-semibold">${data.femmes || 0} / ${data.hommes || 0}</div>
                <div class="text-xs ${data.parityOK ? 'text-green-600' : 'text-orange-600'}">
                  ${data.parityRatio?.toFixed(1) || 0}% F
                </div>
              </div>
              <div>
                <div class="text-gray-600">Score COM</div>
                <div class="font-semibold">${data.scores?.com?.toFixed(2) || 'N/A'}</div>
                <div class="text-xs text-gray-500">
                  TRA: ${data.scores?.tra?.toFixed(2) || 'N/A'}
                </div>
              </div>
              <div>
                <div class="text-gray-600">Quotas</div>
                <div class="font-semibold ${data.quotasOK ? 'text-green-600' : 'text-orange-600'}">
                  <i class="fas fa-${data.quotasOK ? 'check' : 'exclamation-triangle'}"></i>
                  ${data.quotasOK ? 'OK' : 'Dépassés'}
                </div>
                ${data.quotasViolations && data.quotasViolations.length > 0 ? `
                  <div class="text-xs text-orange-600 mt-1">
                    ${data.quotasViolations.map(v => `${v.option}: +${v.excess}`).join(', ')}
                  </div>
                ` : ''}
              </div>
            </div>
            ${Object.keys(data.lv2 || {}).length > 0 || Object.keys(data.opt || {}).length > 0 ? `
              <div class="mt-3 pt-3 border-t border-gray-200 text-xs">
                ${Object.keys(data.lv2 || {}).length > 0 ? `
                  <div class="mb-1"><span class="font-semibold">LV2:</span> ${Object.entries(data.lv2).map(([k,v]) => `${k}(${v})`).join(', ')}</div>
                ` : ''}
                ${Object.keys(data.opt || {}).length > 0 ? `
                  <div><span class="font-semibold">OPT:</span> ${Object.entries(data.opt).map(([k,v]) => `${k}(${v})`).join(', ')}</div>
                ` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('')}
    </div>
  `;
}

/**
 * Render la vue des risques
 */
function renderAnalyticsRisks(snapshot) {
  const risks = snapshot.risks || [];
  const recommendations = snapshot.recommendations || [];
  
  if (risks.length === 0 && recommendations.length === 0) {
    return `
      <div class="text-center text-gray-500 py-12">
        <i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
        <div class="text-xl font-semibold text-green-700">Aucune zone de risque</div>
        <div class="text-gray-600 mt-2">Toutes les contraintes sont respectées</div>
      </div>
    `;
  }
  
  return `
    <div class="space-y-6">
      ${risks.length > 0 ? `
        <div>
          <h3 class="text-xl font-bold mb-4 text-red-700">
            <i class="fas fa-exclamation-triangle mr-2"></i>Zones de risque (${risks.length})
          </h3>
          <div class="space-y-3">
            ${risks.map(risk => `
              <div class="flex items-start gap-4 p-4 rounded-lg border-2 ${
                risk.severity === 'HIGH' 
                  ? 'bg-red-50 border-red-300' 
                  : 'bg-orange-50 border-orange-300'
              }">
                <div class="flex-shrink-0">
                  <span class="inline-block px-3 py-1 text-sm font-bold rounded ${
                    risk.severity === 'HIGH' ? 'bg-red-200 text-red-900' : 'bg-orange-200 text-orange-900'
                  }">
                    ${risk.severity}
                  </span>
                </div>
                <div class="flex-1">
                  <div class="font-bold text-lg mb-1">${risk.class || risk.classe || 'Global'}</div>
                  <div class="text-gray-700">${risk.message}</div>
                  ${risk.details ? `<div class="text-sm text-gray-600 mt-2">${risk.details}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
      
      ${recommendations.length > 0 ? `
        <div>
          <h3 class="text-xl font-bold mb-4 text-blue-700">
            <i class="fas fa-lightbulb mr-2"></i>Recommandations (${recommendations.length})
          </h3>
          <div class="space-y-3">
            ${recommendations.map(rec => `
              <div class="flex items-start gap-4 p-4 rounded-lg border-2 bg-blue-50 border-blue-300">
                <div class="flex-shrink-0">
                  <span class="inline-block px-3 py-1 text-sm font-bold rounded bg-blue-200 text-blue-900">
                    ${rec.priority || 'MEDIUM'}
                  </span>
                </div>
                <div class="flex-1">
                  <div class="font-bold text-lg mb-1">${rec.message}</div>
                  ${rec.action ? `<div class="text-gray-700 mt-2"><i class="fas fa-arrow-right mr-2"></i>${rec.action}</div>` : ''}
                  ${rec.details ? `<div class="text-sm text-gray-600 mt-2">${rec.details}</div>` : ''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

/**
 * Charger l'historique analytique
 */
function loadAnalyticsHistory() {
  const content = document.getElementById('analyticsContent');
  content.innerHTML = '<div class="text-center py-12"><i class="fas fa-spinner fa-spin text-4xl text-purple-600"></i><br><span class="text-gray-600 mt-2">Chargement de l\'historique...</span></div>';
  
  google.script.run
    .withSuccessHandler(function(history) {
      content.innerHTML = renderAnalyticsHistory(history);
    })
    .withFailureHandler(function(error) {
      content.innerHTML = '<div class="text-center text-red-500 py-12"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><br>Erreur: ' + error.message + '</div>';
    })
    .getAnalyticsHistoryForUI();
}

/**
 * Render la vue historique
 */
function renderAnalyticsHistory(history) {
  if (!history || history.length === 0) {
    return `
      <div class="text-center text-gray-500 py-12">
        <i class="fas fa-history text-6xl mb-4"></i>
        <div class="text-xl font-semibold">Aucun historique disponible</div>
        <div class="text-gray-600 mt-2">Lancez une optimisation pour générer le premier snapshot</div>
      </div>
    `;
  }
  
  // Trier par date (plus récent en premier)
  const sorted = history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  const latest = sorted[0];
  const previous = sorted[1];
  
  return `
    <div class="space-y-6">
      <!-- Comparaison avec précédent -->
      ${previous ? `
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-lg border-2 border-purple-200">
          <h3 class="text-xl font-bold mb-4 text-purple-800">
            <i class="fas fa-chart-line mr-2"></i>Évolution depuis la dernière optimisation
          </h3>
          <div class="grid grid-cols-4 gap-4">
            ${renderEvolutionMetric('Variance effectifs', previous.global.varianceEffectifs, latest.global.varianceEffectifs, true)}
            ${renderEvolutionMetric('Parité globale', previous.global.pariteGlobale, latest.global.pariteGlobale, false, '%')}
            ${renderEvolutionMetric('Classes à risque', previous.risks.length, latest.risks.length, true)}
            ${renderEvolutionMetric('Quotas OK', previous.global.quotasRespectesPartout ? 1 : 0, latest.global.quotasRespectesPartout ? 1 : 0, false)}
          </div>
        </div>
      ` : ''}
      
      <!-- Liste des snapshots -->
      <div>
        <h3 class="text-xl font-bold mb-4">
          <i class="fas fa-list mr-2"></i>Historique des optimisations (${history.length})
        </h3>
        <div class="space-y-3">
          ${sorted.map((snap, index) => `
            <div class="metric-card ${
              index === 0 ? 'border-2 border-purple-400 bg-purple-50' : ''
            }">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <div class="font-bold text-lg">
                    ${new Date(snap.timestamp).toLocaleString('fr-FR')}
                    ${index === 0 ? '<span class="ml-2 px-2 py-1 text-xs bg-purple-600 text-white rounded">ACTUEL</span>' : ''}
                  </div>
                  <div class="text-sm text-gray-600">
                    Pipeline: ${snap.pipeline || 'N/A'} | Mode: ${snap.config?.mode?.selected || 'N/A'}
                  </div>
                </div>
                <button onclick="viewSnapshotDetails(${index})" class="btn btn-sm btn-secondary">
                  <i class="fas fa-eye"></i> Détails
                </button>
              </div>
              <div class="grid grid-cols-4 gap-3 text-sm">
                <div>
                  <div class="text-gray-600">Élèves</div>
                  <div class="font-semibold">${snap.global.totalEleves || 0}</div>
                </div>
                <div>
                  <div class="text-gray-600">Variance</div>
                  <div class="font-semibold">${snap.global.varianceEffectifs?.toFixed(2) || 'N/A'}</div>
                </div>
                <div>
                  <div class="text-gray-600">Parité</div>
                  <div class="font-semibold">${snap.global.pariteGlobale?.toFixed(1) || 0}%</div>
                </div>
                <div>
                  <div class="text-gray-600">Risques</div>
                  <div class="font-semibold ${snap.risks.length > 0 ? 'text-orange-600' : 'text-green-600'}">
                    ${snap.risks.length}
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

/**
 * Render une métrique d'évolution
 */
function renderEvolutionMetric(label, oldVal, newVal, lowerIsBetter, unit = '') {
  const diff = newVal - oldVal;
  const isImprovement = lowerIsBetter ? diff < 0 : diff > 0;
  const color = diff === 0 ? 'text-gray-600' : isImprovement ? 'text-green-600' : 'text-red-600';
  const icon = diff === 0 ? 'minus' : isImprovement ? 'arrow-up' : 'arrow-down';
  
  return `
    <div class="bg-white p-4 rounded-lg border border-gray-200">
      <div class="text-gray-600 text-sm mb-1">${label}</div>
      <div class="font-bold text-2xl">${typeof newVal === 'number' ? newVal.toFixed(2) : newVal}${unit}</div>
      <div class="${color} text-sm font-semibold mt-1">
        <i class="fas fa-${icon}"></i>
        ${diff > 0 ? '+' : ''}${typeof diff === 'number' ? diff.toFixed(2) : diff}${unit}
      </div>
    </div>
  `;
}

/**
 * Voir les détails d'un snapshot
 */
function viewSnapshotDetails(index) {
  // Stocker l'index et afficher les détails
  const history = window.analyticsHistory || [];
  if (history[index]) {
    window.currentAnalyticsSnapshot = history[index];
    switchAnalyticsView('overview');
  }
}

/**
 * Export PDF
 */
function exportAnalyticsPDF() {
  const snapshot = window.currentAnalyticsSnapshot;
  if (!snapshot) {
    toast('Aucun snapshot à exporter', 'warning');
    return;
  }
  
  toast('📝 Génération du PDF...', 'info');
  
  // Générer le contenu texte
  let content = `TABLEAU DE BORD ANALYTIQUE\n`;
  content += `Date: ${new Date(snapshot.timestamp).toLocaleString('fr-FR')}\n`;
  content += `Pipeline: ${snapshot.pipeline || 'N/A'}\n\n`;
  
  content += `MÉTRIQUES GLOBALES\n`;
  content += `Élèves total: ${snapshot.global.totalEleves}\n`;
  content += `Parité globale: ${snapshot.global.pariteGlobale?.toFixed(1)}%\n`;
  content += `Variance effectifs: ${snapshot.global.varianceEffectifs?.toFixed(2)}\n\n`;
  
  content += `CLASSES\n`;
  for (const [classe, data] of Object.entries(snapshot.classes || {})) {
    content += `${classe}: ${data.effectif} élèves (${data.femmes}F/${data.hommes}M)\n`;
  }
  
  if (snapshot.risks.length > 0) {
    content += `\nZONES DE RISQUE (${snapshot.risks.length})\n`;
    snapshot.risks.forEach(risk => {
      content += `[${risk.severity}] ${risk.class}: ${risk.message}\n`;
    });
  }
  
  if (snapshot.recommendations.length > 0) {
    content += `\nRECOMMANDATIONS (${snapshot.recommendations.length})\n`;
    snapshot.recommendations.forEach(rec => {
      content += `[${rec.priority}] ${rec.message}\n`;
    });
  }
  
  // Télécharger comme fichier texte (PDF nécessite une bibliothèque)
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `analytics_${new Date().toISOString().split('T')[0]}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('✅ Export terminé', 'success');
}

/**
 * Export CSV
 */
function exportAnalyticsCSV() {
  const snapshot = window.currentAnalyticsSnapshot;
  if (!snapshot) {
    toast('Aucun snapshot à exporter', 'warning');
    return;
  }
  
  toast('📊 Génération du CSV...', 'info');
  
  // Générer le CSV
  let csv = 'Classe,Effectif,Cible,Ecart,Femmes,Hommes,Parite%,PariteOK,COM,TRA,PART,ABS,QuotasOK\n';
  
  for (const [classe, data] of Object.entries(snapshot.classes || {})) {
    csv += `${classe},${data.effectif},${data.target},${data.gapToTarget},${data.femmes},${data.hommes},${data.parityRatio},${data.parityOK ? 'OUI' : 'NON'},${data.scores.com},${data.scores.tra},${data.scores.part},${data.scores.abs},${data.quotasOK ? 'OUI' : 'NON'}\n`;
  }
  
  // Télécharger
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `analytics_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  
  toast('✅ Export CSV terminé', 'success');
}
</script>

<script>
// Version unifiée et tolérante pour accordéons (data-attributes + fallback IDs)
window.toggleSection = function(sectionKey, triggerEl) {
  console.log('toggleSection called for key:', sectionKey);
  try {
    if (triggerEl && triggerEl.stopPropagation) triggerEl.stopPropagation();
    var root = (triggerEl && triggerEl.closest && triggerEl.closest('[data-menu-root]')) || document;
    console.log('  Root:', root.id || 'document');

    // Nouveau schéma (data-attributes)
    var section = root.querySelector('[data-section-id="' + sectionKey + '"]');
    var icon = root.querySelector('[data-section-icon="' + sectionKey + '"]');

    // Ancien schéma (fallback IDs)
    if (!section) section = root.querySelector('#' + sectionKey + 'Section') || root.querySelector('#' + sectionKey);
    if (!icon) icon = root.querySelector('#' + sectionKey + 'SectionIcon') || root.querySelector('#' + sectionKey + 'Icon');

    if (section) {
      section.classList.toggle('hidden');
      console.log('  Section toggled, hidden:', section.classList.contains('hidden'));
    } else {
      console.warn('  Section not found for key:', sectionKey);
    }

    if (icon) {
      icon.classList.toggle('rotate-180');
      console.log('  Icon rotated:', icon.classList.contains('rotate-180'));
    } else {
      console.warn('  Icon not found for key:', sectionKey);
    }
  } catch(e) {
    console.error('toggleSection error:', e);
  }
};

</script>

<script>
// Toggle Admin > Groupes: afficher/cacher le bouton Groupes dans le header
document.addEventListener('DOMContentLoaded', function() {
  const cb = document.getElementById('adminToggleHeaderGroups');
  if (!cb) return;

  // Initialiser l'état depuis le serveur
  if (typeof google !== 'undefined' && google.script && google.script.run) {
    google.script.run
      .withSuccessHandler(function(settings) {
        if (settings) cb.checked = !!settings.SHOW_GROUPS_BUTTON;
      })
      .withFailureHandler(function(err) { console.error('Erreur getUiSettings:', err); })
      .getUiSettings();
  }

  // Appliquer au changement
  cb.addEventListener('change', function() {
    const enabled = !!cb.checked;
    if (typeof google !== 'undefined' && google.script && google.script.run) {
      google.script.run
        .withSuccessHandler(function() {
          if (enabled) {
            if (typeof window.addGroupsButton === 'function') window.addGroupsButton();
          } else {
            if (typeof window.removeGroupsButton === 'function') window.removeGroupsButton();
          }
          if (typeof window.toast === 'function') {
            toast(enabled ? 'Bouton Groupes activé' : 'Bouton Groupes désactivé', 'success');
          }
        })
        .withFailureHandler(function(err) {
          console.error('Erreur setUiSettings:', err);
          if (typeof window.toast === 'function') toast('Erreur: ' + err.message, 'error');
        })
        .setUiSettings({ SHOW_GROUPS_BUTTON: enabled });
    }
  });
});
</script>
<script>
// Pont "Régler" -> "Paramètres (Admin)" + fallback direct
(function () {
  window.doReglerFilter = function (filter) {
    try {
      // 1) Essayer de relayer vers le bouton Admin correspondant (s'il existe)
      var adminBtn = document.querySelector('#parametresSection .filter-btn-compact[data-filter="' + filter + '"]');
      if (adminBtn) { adminBtn.click(); return; }
      // 2) Sinon, appliquer le filtre directement (fonction globale déjà présente)
      if (typeof window.applyQuickFilter === 'function') { window.applyQuickFilter(filter); return; }
      if (window.FilterManager && typeof window.FilterManager.applyQuickFilter === 'function') { window.FilterManager.applyQuickFilter(filter); return; }
      console.warn('Aucune méthode de filtrage trouvée pour', filter);
    } catch (e) {
      console.error('doReglerFilter error:', e);
      if (typeof window.toast === 'function') { toast('Erreur filtre: ' + e.message, 'error'); }
    }
  };

  window.doReglerHelp = function (kind) {
    try {
      if (kind === 'shortcuts') {
        // Appeler directement toggleKeyboardHelp si disponible
        if (typeof window.toggleKeyboardHelp === 'function') {
          window.toggleKeyboardHelp();
        } else {
          // Fallback: basculer le panneau directement
          const panel = document.getElementById('keyboardShortcuts');
          if (panel) panel.classList.toggle('hidden');
        }
      } else if (kind === 'tutorial') {
        // Appeler la fonction globale showTutorial
        if (typeof window.showTutorial === 'function') {
          window.showTutorial();
        } else {
          console.warn('showTutorial function not found');
        }
      }
    } catch (e) {
      console.error('doReglerHelp error:', e);
    } finally {
      // Fermer les menus déroulants
      ['dropdownAdmin','dropdownRegler','dropdownEditer','dropdownComparer'].forEach(function(id){
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }
  };

  // Délégation de clics dans Régler et Admin pour Filtres & Aide
  document.addEventListener('DOMContentLoaded', function() {
    ['#dropdownRegler', '#dropdownAdmin'].forEach(function(rootSel) {
      var root = document.querySelector(rootSel);
      if (!root) return;
      root.addEventListener('click', function(e) {
        var btn = e.target.closest('.filter-btn-compact');
        if (btn) {
          e.preventDefault();
          var filter = btn.dataset.filter;
          if (typeof window.applyQuickFilter === 'function') { window.applyQuickFilter(filter); return; }
          if (window.FilterManager && typeof window.FilterManager.applyQuickFilter === 'function') { window.FilterManager.applyQuickFilter(filter); return; }
          return;
        }
        if (e.target.closest('[data-action="shortcuts"]')) {
          e.preventDefault();
          if (typeof window.toggleKeyboardHelp === 'function') {
            window.toggleKeyboardHelp();
          } else {
            const panel = document.getElementById('keyboardShortcuts');
            if (panel) panel.classList.toggle('hidden');
          }
          // Fermer le menu courant
          if (root) root.classList.add('hidden');
          return;
        }
        if (e.target.closest('[data-action="tutorial"]')) {
          e.preventDefault();
          if (typeof window.showTutorial === 'function') window.showTutorial();
          if (root) root.classList.add('hidden');
          return;
        }
      });
    });
  });
})();
</script>

<script>
// Alias global pour raccourcis clavier (btnHelpAdmin/btnTutorialAdmin supprimés du menu Admin)
(function(){
  // Expose alias for external callers
  window.showShortcuts = window.showShortcuts || function(){
    if (typeof window.toggleKeyboardHelp === 'function') {
      window.toggleKeyboardHelp();
    } else {
      var panel = document.getElementById('keyboardShortcuts');
      if (panel) panel.classList.toggle('hidden');
    }
  };
  
  window.showTutorial = window.showTutorial || function(){
    console.log('🎓 Ouverture du tutoriel...');
    // Priorité au tutoriel OnboardingTour si disponible
    if (typeof window.OnboardingTour !== 'undefined' && typeof window.OnboardingTour.start === 'function') {
      window.OnboardingTour.start();
      return;
    }
    // Fallback
    if (typeof window.toast === 'function') {
      toast('Tutoriel à venir', 'info');
    }
  };
})();
</script>

<script>
// Ponts manquants pour Paramètres → Données (Import/Export/Règles)
(function(){
  // Aliases sûrs (si déjà définis ailleurs, on ne remplace pas)
  window.openImportScoresModal = window.openImportScoresModal || function () {
    try {
      if (typeof window.addSubjectScores === 'function') return window.addSubjectScores();
      if (window.ScoreImporter && typeof window.ScoreImporter.importScoresFromINT === 'function') return window.ScoreImporter.importScoresFromINT();
      console.warn('Import Scores: aucune implémentation trouvée');
    } catch(e) { console.error('openImportScoresModal error:', e); }
  };

  window.openExportModal = window.openExportModal || function () {
    try {
      var modal = document.getElementById('exportModal');
      var overlay = document.getElementById('overlay');
      if (modal) modal.classList.remove('hidden');
      if (overlay) { overlay.classList.remove('hidden'); overlay.classList.add('active'); }
    } catch(e) { console.error('openExportModal error:', e); }
  };

  document.addEventListener('DOMContentLoaded', function(){
    var dropdown = document.getElementById('dropdownAdmin');

    var btnImport = document.getElementById('menuImportScoresAdmin');
    if (btnImport) btnImport.addEventListener('click', function(){
      if (typeof window.openImportScoresModal === 'function') window.openImportScoresModal();
      if (dropdown) dropdown.classList.add('hidden');
    });

    var btnExport = document.getElementById('btnExportAdmin');
    if (btnExport) btnExport.addEventListener('click', function(){
      if (typeof window.openExportModal === 'function') window.openExportModal();
      if (dropdown) dropdown.classList.add('hidden');
    });

    var btnRules = document.getElementById('menuRulesAdmin');
    if (btnRules) btnRules.addEventListener('click', function(){
      if (typeof window.openRulesModal === 'function') window.openRulesModal();
      var overlay = document.getElementById('overlay');
      if (overlay) { overlay.classList.remove('hidden'); overlay.classList.add('active'); }
      if (dropdown) dropdown.classList.add('hidden');
    });
  });
})();
</script>

</body>
</html>