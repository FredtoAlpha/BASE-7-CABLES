/**
 * ONBOARDING TOUR - Tour guid√© interactif
 * Utilise Shepherd.js pour guider les nouveaux utilisateurs
 */

const OnboardingTour = {
  tour: null,
  
  /**
   * Cr√©e et d√©marre le tour
   */
  start() {
    // V√©rifier si Shepherd.js est charg√©
    if (typeof Shepherd === 'undefined') {
      console.error('Shepherd.js non charg√©. Inclure: https://cdn.jsdelivr.net/npm/shepherd.js@latest/dist/js/shepherd.min.js');
      return;
    }
    
    this.tour = new Shepherd.Tour({
      useModalOverlay: true,
      defaultStepOptions: {
        cancelIcon: {
          enabled: true
        },
        classes: 'shepherd-theme-custom',
        scrollTo: { behavior: 'smooth', block: 'center' }
      }
    });
    
    // √âtape 1: Bienvenue
    this.tour.addStep({
      id: 'welcome',
      title: 'üëã Bienvenue !',
      text: `
        <p class="mb-3">Bienvenue dans l'outil de r√©partition des classes.</p>
        <p>Ce tour guid√© vous pr√©sentera les fonctionnalit√©s principales.</p>
      `,
      buttons: [
        {
          text: 'Passer',
          action: this.tour.cancel,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 2: Configuration
    this.tour.addStep({
      id: 'config',
      title: '‚öôÔ∏è Configuration',
      text: `
        <p>Commencez par configurer la structure de vos classes.</p>
        <p class="mt-2 text-sm text-gray-600">
          D√©finissez le nombre de classes, les capacit√©s et les options disponibles.
        </p>
      `,
      attachTo: {
        element: '[data-tour="config-btn"]',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 3: Chargement donn√©es
    this.tour.addStep({
      id: 'load',
      title: 'üìÇ Chargement des donn√©es',
      text: `
        <p>Chargez vos √©l√®ves depuis:</p>
        <ul class="list-disc ml-5 mt-2">
          <li>CONSOLIDATION (nouvelle r√©partition)</li>
          <li>Anciennes classes (modification)</li>
        </ul>
      `,
      attachTo: {
        element: '[data-tour="load-btn"]',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 4: Optimisation automatique
    this.tour.addStep({
      id: 'optimize',
      title: 'üöÄ Optimisation automatique',
      text: `
        <p>Lancez l'optimisation automatique pour r√©partir les √©l√®ves selon:</p>
        <ul class="list-disc ml-5 mt-2 text-sm">
          <li>Options et LV2</li>
          <li>Codes ASSO/DISSO</li>
          <li>Parit√© F/M</li>
          <li>Scores et √©quilibre</li>
        </ul>
      `,
      attachTo: {
        element: '[data-tour="optimize-btn"]',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 5: Drag & Drop
    this.tour.addStep({
      id: 'dragdrop',
      title: 'üñ±Ô∏è Ajustements manuels',
      text: `
        <p>Apr√®s l'optimisation, ajustez manuellement:</p>
        <ul class="list-disc ml-5 mt-2 text-sm">
          <li>Glissez-d√©posez les √©l√®ves entre classes</li>
          <li>Les stats se mettent √† jour en temps r√©el</li>
          <li>Les warnings s'affichent automatiquement</li>
        </ul>
      `,
      attachTo: {
        element: '[data-tour="classes-container"]',
        on: 'top'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 6: Statistiques
    this.tour.addStep({
      id: 'stats',
      title: 'üìä Statistiques en temps r√©el',
      text: `
        <p>Surveillez les statistiques qui se mettent √† jour automatiquement:</p>
        <ul class="list-disc ml-5 mt-2 text-sm">
          <li>Parit√© F/M</li>
          <li>Capacit√© des classes</li>
          <li>Distribution LV2/Options</li>
        </ul>
      `,
      attachTo: {
        element: '[data-tour="stats-panel"]',
        on: 'left'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 7: Filtres
    this.tour.addStep({
      id: 'filters',
      title: 'üîç Filtres avanc√©s',
      text: `
        <p>Utilisez les filtres pour trouver rapidement des √©l√®ves:</p>
        <ul class="list-disc ml-5 mt-2 text-sm">
          <li>Multi-crit√®res (sexe, LV2, options, scores)</li>
          <li>Recherche intelligente</li>
          <li>Sauvegarde de vues</li>
        </ul>
      `,
      attachTo: {
        element: '[data-tour="filters-btn"]',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 8: Validation
    this.tour.addStep({
      id: 'validation',
      title: '‚úÖ Validation',
      text: `
        <p>Avant de finaliser, v√©rifiez:</p>
        <ul class="list-disc ml-5 mt-2 text-sm">
          <li>Rapport de validation complet</li>
          <li>Liste exhaustive des erreurs/warnings</li>
          <li>Statistiques globales</li>
        </ul>
      `,
      attachTo: {
        element: '[data-tour="validate-btn"]',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 9: Snapshots
    this.tour.addStep({
      id: 'snapshots',
      title: 'üíæ Historique',
      text: `
        <p>Des snapshots sont cr√©√©s automatiquement avant chaque action critique.</p>
        <p class="mt-2 text-sm text-gray-600">
          Vous pouvez revenir √† n'importe quelle version pr√©c√©dente.
        </p>
      `,
      attachTo: {
        element: '[data-tour="history-btn"]',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Suivant',
          action: this.tour.next
        }
      ]
    });
    
    // √âtape 10: Finalisation
    this.tour.addStep({
      id: 'finalize',
      title: 'üéâ Finalisation',
      text: `
        <p>Une fois satisfait de la r√©partition:</p>
        <ul class="list-disc ml-5 mt-2 text-sm">
          <li>Sauvegardez (cr√©e les onglets INT)</li>
          <li>Exportez en PDF/Excel</li>
          <li>Consultez les graphiques</li>
        </ul>
        <p class="mt-3 font-semibold">Bon travail ! üöÄ</p>
      `,
      attachTo: {
        element: '[data-tour="save-btn"]',
        on: 'bottom'
      },
      buttons: [
        {
          text: 'Pr√©c√©dent',
          action: this.tour.back,
          classes: 'shepherd-button-secondary'
        },
        {
          text: 'Terminer',
          action: () => {
            this.tour.complete();
            this.markAsCompleted();
          }
        }
      ]
    });
    
    // D√©marrer le tour
    this.tour.start();
  },
  
  /**
   * Marque le tour comme compl√©t√©
   */
  markAsCompleted() {
    try {
      localStorage.setItem('onboarding:completed', 'true');
      localStorage.setItem('onboarding:completedAt', new Date().toISOString());
    } catch (e) {
      console.error('Erreur sauvegarde onboarding:', e);
    }
    
    if (typeof Toast !== 'undefined') {
      Toast.show('Tour guid√© termin√© ! Vous pouvez le relancer √† tout moment.', 'success');
    }
  },
  
  /**
   * V√©rifie si le tour a √©t√© compl√©t√©
   */
  isCompleted() {
    try {
      return localStorage.getItem('onboarding:completed') === 'true';
    } catch (e) {
      return false;
    }
  },
  
  /**
   * R√©initialise le tour
   */
  reset() {
    try {
      localStorage.removeItem('onboarding:completed');
      localStorage.removeItem('onboarding:completedAt');
    } catch (e) {
      console.error('Erreur reset onboarding:', e);
    }
  },
  
  /**
   * D√©marre automatiquement si pas encore compl√©t√©
   */
  autoStart() {
    if (!this.isCompleted()) {
      // Attendre que la page soit charg√©e
      setTimeout(() => {
        const shouldStart = confirm(
          'Bienvenue ! Souhaitez-vous suivre un tour guid√© de l\'interface ?'
        );
        
        if (shouldStart) {
          this.start();
        } else {
          this.markAsCompleted();
        }
      }, 1000);
    }
  }
};

// Exposition globale
if (typeof window !== 'undefined') {
  window.OnboardingTour = OnboardingTour;
}

if (typeof global !== 'undefined') {
  global.OnboardingTour = OnboardingTour;
}

console.log('‚úÖ Module OnboardingTour charg√©');
